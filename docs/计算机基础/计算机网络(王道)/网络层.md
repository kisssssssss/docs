---
title: 网络层
index: 5
typora-root-url: ./..\..\..\..\IMG\docs\计算机\计算机网络
---

# 网络层概述

网络层的主要目的==在任意结点间进行数据报不可靠传输==。

网络层的主要任务就是**将分组从源主机经过多个网络和多段链路传输到目的主机**，可以将该任务划分为**分组转发**和**路由选择**两种重要的功能。

## 冲突域

冲突域是指能产生冲突的所有设备的集合，这些结点之间存在介质争用的现象。

在OSI参考模型中，冲突域被视为第1层的概念，像集线器、中继器等简单无脑复制转发信号的第1层设备所连接的结点都属于同一个冲突域，也就是说它们不能划分冲突域。而第2层（网桥、交换机）、第3层（路由器）设备都可以划分冲突域。

::: tip

“域”表示冲突或广播在其中发生并传播的区域。

:::

## 广播域

广播域是指接收同样广播消息的结点集合。也就是说，在该集合中的任何一个结点发送一个广播帧，其他能收到这个帧的结点都被认为是该广播域的一部分。

在OSI参考模型中，广播域被视为第2层的概念，像第1层（集线器等）、第2层（交换机等）设备所连接的结点都属于同一个广播域。而路由器，作为第3层设备，则可以划分广播域，即可以连接不同的广播域。

通常所说的局域网(LAN)特指使用路由器分割的网络，也就是广播域。

## 路由与转发

路由器主要完成两个功能：

- ==路由选择==（确定哪一条路径）

  根据路由协议**构造路由表**，同时经常或定期地与相邻路由器交换信息，获取网络最新拓扑，动态更新**维护路由表**，以决定分组到达目的地结点的最优路径。

  虽然一些路由协议也将延迟等作为参数进行路由选择，但路由协议**使用得最多的参数是传输距离**，此外还有一些其他参数。

- ==分组转发==（当一个分组到达时所采取的动作）

  指路由器根据转发表将分组从合适的端口转发出去，关键操作是转发表查询、转发及相关的队列管理和任务调度等。

  路由器只能根据IP进行转发。

路由表是根据路由选择算法得出的，而转发表是从路由表得出的。转发表的结构应当使查找过程最优化，路由表则需要最优化网络拓扑变化的计算。

路由表通常包含==目的网络==和到==达该目的网络路径上的下一个路由器的IP地址==。

路由器转发一个分组的过程如下：**先接收整个分组**，然后**对分组进行错误检查**，若出错，则**丢弃**错误的分组；否则**存储**该正确的分组。最后根据路由选择协议，将正确的分组转发到合适的端口，这种机制称为==存储转发机制==。

![](230.png)

在讨论路由选择的原理时，往往不区分转发表和路由表，而笼统地使用路由表一词。

## 路由器

路由器主要实现**物理层、数据链路层、网络层的功能**。

路由器是一种具有==多个输入/输出端口==的==专用计算机==，其任务是连接不同的网络（**连接异构网络**）并==完成分组转发==。在多个逻辑网络（即多个广播域）互连时必须使用路由器。

路由器是第三层设备，向传输层及以上层次隐藏下层的具体实现，所以**在路由器互连的多个局域网的结构中**，每个局域网的==物理层、数据链路层、网络层协议可以不同==。而网络层之上的协议数据是路由器所不能处理的，因此==网络层以上的高层协议必须相同==。

路由器是第三层设备，要处理的内容比第二层设备交换机更多，因而**转发速度比交换机慢**。

通常的路由器可以**支持多种网络层协议**，并提供不同协议之间的分组转发。例如使用特定的路由器连接IPv4与IPv6网络，就是典型的网络层协议不同而实现互连的例子。

路由器**工作在网络层，不转发广播包**（目的地址为255.255.255.255的IP包），因此能够==分隔广播域==，抑制网络风暴。

---

当源主机向目标主机发送数据报时，路由器先检查源主机与目标主机是否连接在同一个网络上。

- 若源主机和目标主机**在同一个网络上**，则==直接交付==而**无须通过路由器**。
- 若源主机和目标主机**不在同一个网络上**，则路由器按照转发表（由路由表得出）指出的路由将分组转发给下一个路由器，这称为==间接交付==。

可见，在同一个网络中传递数据无须路由器的参与，而跨网络通信必须通过路由器进行转发。

---

从结构上看，路由器由**路由选择**和**分组转发**两部分构成。

从模型的角度看，路由器是网络层设备，它实现了网络模型的下三层，即物理层、数据链路层和网络层。

![](339.png)

::: tip

若一个存储转发设备实现了某个层次的功能，则它可以互连两个在该层次上使用不同协议的网段（网络）。若网桥实现了物理层和数据链路层，则网桥可以互连两个物理层和数据链路层不同的网段；但中继器实现了物理层后，却不能互连两个物理层不同的网段，这是因为中继器不是存储转发设备，它属于直通式设备。

:::

![](340.png)

==转发表是从路由表得出的==，其表项和路由表项有直接的对应关系。但转发表的格式和路由表的格式不同，其结构应使查找过程最优化，而路由表则需对网络拓扑变化的计算最优化。

转发表中含有一个分组将要发往的目的地址，以及分组的下一跳（即下一步接收者的目的地址，实际为MAC地址）。为了减少转发表的重复项目，可以使用一个默认路由代替所有具有相同“下一跳”的项目，并将默认路由设置得比其他项目的优先级低。

==路由表总是用软件来实现的==；==转发表可以用软件和特殊的硬件来实现==。

注意转发和路由选择的区别：

- “转发”是路由器根据转发表把收到的IP数据报从合适的端口转发出去，它仅涉及一个路由器。
- “路由选择”则涉及很多路由器，路由表是许多路由器协同工作的结果。这些路由器按照复杂的路由算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由，并由此构造出整个路由表。

**路由表不等于转发表，分组的实际转发是靠直接查找转发表，而不是查找路由表**。

![](341.png)

## 网络层的服务

==分组交换==网根据其通信子网向端点系统提供的服务，还可**进一步分为**==面向连接的虚电路服务==和==无连接的数据报服务==。这两种服务方式都是由网络层提供的。

- OSI参考模型曾主张在网络层使用面向连接的**虚电路服务**，认为应**由==网络自身==来保证通信的可靠性**。

  虚电路是==面向连接的==，它提供的是==可靠的服务==，能保证**数据的可靠性和有序性**，但是一旦虚电路中的某个结点出现故障，就必须重新建立一条虚电路。

  对于出错率高的传输系统，易出现结点故障，因此采用数据报方式更合适。

- TCP/IP体系的网络层提供的是无连接的**数据报服务**，其核心思想是应**由==用户主机==来保证通信的可靠性**。

  数据报是==无连接的==，它提供的是==不可靠的服务==，分组有可能丢失、失序，也不保证到达的时间，传输**既不保证可靠性，又不保证分组的按序到达**。

### 分组交换-虚电路

在虚电路方式中，当两台计算机进行通信时，应当==先建立网络层的连接==，也就是建立一条**逻辑上的虚电路**(VirtualCircuit, VC)，连接一旦建立，就固定了虚电路对应的物理路径。

::: tip

虚电路提供的服务包括：

- 永久性虚电路（PVC）：提前定义好的、基本上不需要任何建立时间的端点之间的连接。
- 交换型虚电路（SVC）：端点之间的一种临时性连接，这些连接只持续所需的时间，且在会话结束时就取消这种连接。



:::

![](226.png)

每次建立虚电路时，将一个未用过的虚电路号(VCID)分配给该虚电路，以区别于本系统中的其他虚电路，然后双方就沿着已建立的虚电路传送分组。

分组的**首部仅在连接建立时使用完整的目的地址**，**之后**每个分组的首部**只需携带这条虚电路的编号**即可。

在虚电路网络中的每个结点上都维持一张虚电路表，表中每项记录一个打开的虚电路的信息，包括在接收链路和发送链路上的虚电路号、前一结点和下一结点的标识，它是在虚电路建立过程中确定的。

---

与电路交换类似，整个通信过程分为三个阶段：

1. ==虚电路建立==

   数据传输前，主机A与主机B先建立连接，主机A发出“呼叫请求”分组，该分组通过中间结点送往主机B，若主机B同意连接，则发送“呼叫应答”分组予以确认。

2. ==数据传输==

   虚电路建立后，主机A和主机B就可相互传送数据分组。

3. ==虚电路释放==

   传送结束后，主机A通过发送“释放请求”分组来拆除虚电路，逐段断开整个连接。

![](227.png)

---

虚电路服务具有如下特点：

1. 虚电路通信链路的建立和拆除需要时间开销，对交互式应用和少量的短分组情况显得很浪费，但==对长时间、频繁的数据交换效率较高==。
2. 虚电路的路由选择体现在连接建立阶段，连接建立后，就确定了传输路径。
3. 虚电路提供了**可靠的通信功能，本身就可实现差错控制，不需要依赖其他协议实现差错控制**;能**保证每个分组正确且有序到达**。此外，还可对两个端点的流量进行控制，当接收方来不及接收数据时，可以通知发送方暂缓发送。
4. 虚电路有一个致命的弱点，即==当网络中的某个结点或某条链路出现故障而彻底失效时，所有经过该结点或该链路的虚电路将遭到破坏==。
5. ==分组首部包含的是虚电路号==，不包含目的地址,相对于数据报方式，其开销小。

虚电路之所以是虚，是因为这条电路不是专用的，每个结点到其他结点之间的链路可能同时有若干条虚电路通过，也可能同时在多个结点之间建立虚电路。

网络中的传输是否有确认与网络层提供的两种服务没有任何关系。

### 分组交换-数据报

在互联网采用的TCP/IP体系结构中，网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。也就是说，所传送的分组可能出错、丢失、重复、失序或超时，这就使得网络中的路由器可以做得比较简单，而且价格低廉（与电话网络相比）。

网络在发送分组前==不需要先建立连接==。

源主机的高层协议将报文拆成若干较小的数据段，并加上地址等控制信息后构成分组。中间结点存储分组很短一段时间，找到最佳的路由后，尽快转发每个分组。

![](228.png)

当分组正在某一链路上传送时，**分组并不占用网络其他部分的资源**。因为**采用存储转发技术，资源是共享的**，所以主机A在发送分组时，主机B也可同时向其他主机发送分组。

---

数据报服务具有如下特点：

1. **发送分组前不需要建立连接**。发送方可随时发送分组，网络中的结点可随时接收分组。
2. 网络**尽最大努力交付，传输不保证可靠性**，所以分组可能出错或丢失；网络为每个分组独立地选择路由，转发的路径可能不同，因此分组不一定按序到达目的结点。
3. 发送的分组中要**包括发送方和接收方的完整地址**，以便可以独立传输。
4. 当分组在交换结点**存储转发时，需要排队等候处理**，这会带来一定的时延。当网络发生拥塞时，这种时延会大大增加，交换结点还可根据情况丢弃部分分组。
5. 网络具有余路径，当某个交换结点或一条链路出现故障时，可相应地更新转发表，寻找另一条路径转发分组，对故障的适应能力强。
6. 收发双方**不独占某条链路，资源利用率较高**。

采用这种设计思想的好处是：网络的造价大大降低、运行方式灵活、能够适应多种应用。

### 比较

![](379.png)

## 异构网络互连

互联网是由全球范围内数以百万计的异构网络互连起来的。这些网络的拓扑结构、寻址方案、差错处理方法、路由选择机制等都不尽相同，即==数据链路层和物理层均不同==。网络层所要完成的任务之一就是使这些异构的网络实现互连。

网络互连是指将两个以上的计算机网络，通过一定的方法，用一些中继系统相互连接起来，以构成更大的网络系统。

根据所在的层次，中继系统分为以下4种：

1. 物理层中继系统：转发器，集线器。
2. 数据链路层中继系统：网桥或交换机。
3. 网络层中继系统：路由器。
4. 网络层以上的中继系统：网关。

当使用物理层或数据链路层的中继系统时，只是把一个网络扩大了，而从网络层的角度看，它仍然是同一个网络，一般并不称为网络互连。因此，==网络互连通常是指用路由器进行网络连接和路由选择==。

::: tip

路由器是一台专用计算机，用于在互联网中进行路由选择。

许多有关TCP/IP的文献也将网络层的路由器称为网关。

:::

TCP/IP在网络互连上采用的做法是在网络层采用标准化协议，但相互连接的网络可以是异构的。

虚拟互连网络也就是逻辑互连网络，意思是互连起来的各种物理网络的异构性本来是客观存在的，但是通过IP协议就可使这些性能各异的网络在网络层上看起来像是一个统一的网络。这种**使用IP协议的虚拟互连网络可简称为IP网络**。

![](229.png)

使用IP网络的好处是：当IP网上的主机进行通信时，就好像在单个网络上通信一样，而看不见互连的各个网络的具体异构细节（如具体的编址方案、路由选择协议等）。

## 软件定义网络(SDN)

网络层的主要任务是转发和路由选择。可以将网络层抽象地划分为数据平面（也称转发层面）和控制平面，转发是数据平面实现的功能，而路由选择是控制平面实现的功能。

![](376.png)

**软件定义网络**(SoftwareDefinedNetwork, **SDN**)是近年流行的一种创新网络架构，它采用集中式的控制平面和分布式的数据平面，两个平面相互分离，控制平面利用控制-数据接口对数据平面上的路由器进行集中式控制，方便软件来控制网络。

传统网络中的路由器既有转发表又有路由选择软件，即既有数据平面又有控制平面。但是在SDN结构中，路由器都变得简单了，它的路由选择软件都不需要了，因此路由器之间不再相互交换路由信息。

在网络的控制平面有一个逻辑上的远程控制器（可由多个服务器组成）。远程控制器掌握各主机和整个网络的状态，为每个分组计算出最佳路由，通过Openflow协议（或其他途径）将转发表（在SDN中称为流表）下发给路由器。路由器的工作很单纯，即收到分组、查找转发表、转发分组。

![](377.png)

这样，网络又变成集中控制的，而本来互联网是分布式的。SDN并非要把整个互联网都改造成集中控制模式，这是不现实的。然而，在某些具体条件下，特别是像一些大型的数据中心之间的广域网，使用SDN模式来建造，就可使网络的运行效率更高。

SDN的可编程性通过为开发者提供强大的编程接口，使得网络具有很好的编程性。

- 对上层应用的开发者，SDN提供的**编程接口**称为**北向接口**，北向接口提供了一系列丰富的API，开发者可以在此基础上设计自已的应用，而不必关心底层的硬件细节。

- SDN控制器和转发设备**建立双向会话的接口**称为**南向接口**，通过不同的南向接口协议（如Openflow），SDN控制器就可兼容不同的硬件设备，同时可在设备中实现上层应用的逻辑。
- SDN控制器集群**内部控制器之间的通信接口**称为**东西向接口**，用于增强整个控制平面的可靠性和可拓展性。

![](378.png)

SDN的优点：

1. 全局集中式控制和分布式高速转发，既利于控制平面的全局优化，又利于高性能的网络转发。
2. 灵活可编程与性能的平衡，控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置。
3. 降低成本，控制和数据平面分离后，尤其是在使用开放的接口协议后，就实现了网络设备的制造与功能软件的开发相分离，从而有效降低了成本。

SDN的问题：

1. 安全风险，集中管理容易受攻击，若崩溃，则整个网络会受到影响。
2. 瓶颈问题，原本分布式的控制平面集中化后，随着网络规模扩大，控制器可能成为网络性能的瓶颈。

# IPV4

![](231.png)

IPv4即现在普遍使用的网际协议(IntemetProtocol, IP)。

IPv4地址是给因特网(Internet)上的每一个主机（或路由器）的每一个接口分配的一个在全世界范围内唯一的==32比特==的标识符。IP地址由互联网名字和数字分配机构ICANN进行分配。

IP定义数据传送的基本单元一一IP分组及其确切的数据格式。IP也包括一套规则，指明分组如何处理、错误怎样控制。

## IPv4地址

### 表示方法

由于IPv4地址由32比特构成，不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制表示方法**以方便用户使用。

![](232.png)

![](233.png)

### 分类编址 

![](234.png)

![](236.png)

无论哪类IP地址，都由网络号和主机号两部分组成。即
$$
IP地址::=\{<网络号>,<主机号>\}
$$

- 网络号标志主机（或路由器）所连接到的网络，一个网络号在整个互联网范围内必须是唯一的。
- 主机号标志该主机（或路由器），一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。

由此可见，一个IP地址在整个互联网范围内是唯一的。

#### 特殊IP地址

在各类IP地址中，有些IP地址具有特殊用途，不用作主机的IP地址：

- 主机号全为0表示本网络本身，不能分配给主机（或路由器）的各接口。。
- 主机号全为1表示本网络的广播地址，又称直接广播地址，不能分配给主机（或路由器）的各接口。。
- 127.x.x.x保留为环回自检地址，此地址表示任意主机本身，目的地址为环回地址的IP数据报永远不会出现在任何网络上。
- 32位全为0，即0.0.0.0表示本网络上的本主机。
- 32位全为1，即255.255.255.255表示整个TCP/IP网络的广播地址，又称受限广播地址。实际使用时，因为路由器对广播域的隔离，255.255.255.255等效为本网络的广播地址。

![](241.png)

![](235.png)

![](237.png)

![](238.png)

![](239.png)

![](240.png)

#### IP地址特点

1. 每个IP地址都由网络号和主机号两部分组成，因此IP地址是一种分等级的地址结构。

   分等级的好处是：

   - IP地址管理机构在分配IP地址时只分配网络号，而主机号则由得到该网络的单位自行分配，方便了IP地址的管理；
   - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目标主机号），从而减小了路由表所占的存储空间。

2. IP地址是标志一台主机（或路由器）和一条链路的接口。当一台主机同时连接到两个网络时，该主机就必须同时具有两个相应的IP地址，其网络号必须是不同的。因此**路由器至少应具有两个或两个以上的IP地址，每个端口都有一个不同网络号的IP地址**。

3. 用**转发器或桥接器（网桥等）连接的若干LAN仍然是同一个网络**（同一个广播域），因此该LAN中所有主机的IP地址的**网络号必须相同，主机号必须不同**。

4. 在IP地址中，所有分配到网络号的网络都是平等的。

5. 在同一个局域网上的主机或路由器接口的IP地址中的网络号必须是相同的。

### 划分子网编址

把IP网络划分成子网，这样做的好处减少广播域的大小。增加子网的数量是子网划分的结果，并不是目的。

#### 划分子网

两级IP地址的缺点：IP地址空间的利用率有时很低；给每个物理网络分配一个网络号会使路由表变得太大，进而使网络性能变坏；两级IP地址不够灵活。

![](242.png)

![](243.png)

从1985年起，在IP地址中又增加了一个“子网号字段”，使两级IP地址变成了三级IP地址。这种做法称为划分子网。

划分子网已成为互联网的正式标准协议。

划分子网的基本思路如下：

- 划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的一个网络。

- 划分子网的方法是**从网络的主机号借用若干位作为子网号**，当然主机号也相应减少了相同的位数。三级IP地址的结构：
  $$
  IP地址::=\{<网络号>,<子网号>,<主机号>\}
  $$

- 路由器**转发分组根据的仍然是IP数据报的目的网络号**，本单位的路由器**收到IP数据报后，再按目的网络号和子网号找到目的子网**。最后把IP数据报交付给目的主机。

::: tip

1. 划分子网只是把IP地址的主机号部分进行再划分，而不改变IP地址原来的网络号。因此，**从一个IP地址本身无法判断该主机所连接的网络是否进行了子网划分**。
2. 子网中的主机号全0或全1的地址不能被指派，其中主机号全0的地址为子网的网络地址，主机号全1的地址为子网的广播地址。
3. 划分子网增加了灵活性，但减少了能够连接在网络上的主机总数。

:::

#### 子网掩码

子网掩码可用来指明分类IP地址的主机号部分被借用了多少位作为子网号。

子网掩码是一个长32位的二进制串，由一串1和跟随的一串0组成。其中，1对应于IP地址中的网络号及子网号，而0对应于主机号。

![](244.png)

主机或路由器只需将IP地址和其对应的子网掩码逐位“与”（AND运算），就可得出相应子网的网络地址。

![](245.png)

![](246.png)

![](247.png)

![](248.png)

默认子网掩码是指在未划分子网的情况下使用的子网掩码。

![](249.png)

#### 默认网关

默认网关是==子网与外部网络连接的设备==，也就是连接本机或子网的路由器接口的IP地址。

当主机发送数据时，**根据所发送数据的目的IP地址，通过子网掩码来判定目的主机是否在子网中**，若目的主机在子网中，则直接发送。若目的主机不在子网中，则将该数据发送到默认网关，由网关（路由器）将其转发到其他网络，进一步寻找目的主机。

现在的互联网标准规定：所有网络都必须使用子网掩码。若一个网络未划分子网，则该网络的子网掩码就使用默认子网掩码。

子网掩码是一个网络的重要属性，路由器相互之间交换路由信息时，必须将自己所在网络的子网掩码告诉对方。分组转发时，路由器将分组的目标地址和某网络的子网掩码按位相与，若结果与该网络地址一致，则路由匹配成功，路由器将分组转发至该网络。

在使用子网掩码的情况下：

1. 一台主机在设置IP地址信息的同时，必须设置子网掩码。
2. 同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码。
3. 路由器的路由表中所包含的信息主要内容有目的网络地址、子网掩码、下一跳地址。


### 无分类编址CIDR

#### 无分类编址

==无分类域间路由选择==(ClasslessInter-DomainRouting, ==CIDR==)是在变长子网掩码的基础上，提出的一种消除传统A、B、C类地址及划分子网的概念。

无分类编址方法使用的地址掩码与划分子网使用的子网掩码类似，由==32比特构成==。用左起多个连续的比特1对应IPv4地址中的网络前缀；之后的多个连续的比特0对应IPv4地址中的主机号。

CIDR使用网络前缀的概念代替网络的概念，与传统分类IP地址最大的区别就是，网络前缀的位数不是固定的，可以任意选取。
$$
IP地址::=\{<网络前缀>,<主机号>\}。
$$
![](250.png)

CIDR还使用==斜线记法==（或称CIDR记法），即记为“==IP地址/网络前缀所占的位数==”。

![](251.png)

CIDR将网络前缀都相同的连续IP地址组成一个**CIDR地址块**。只要知道CIDR地址块中的任何一个地址，就能知道这个地址块的最小地址和最大地址，以及地址块中的地址数。

CIDR虽然不使用子网，但仍然使用“掩码”一词。“CIDR不使用子网”是指CIDR并没有在32位地址中指明若干位作为子网字段。但分配到一个CIDR地址块的单位，仍可在本单位内根据需要划分出一些子网。例如，某单位分配到地址块/20，就可继续划分为8个子网（从主机号中借用3位来划分子网），这时每个子网的网络前缀就变成了23位。

CIDR地址块中的地址数一定是2的整数次幂，实际可指派的地址数通常为$2^N-2$，N表示主机号的位数，==主机号全0代表网络号，主机号全1为广播地址==。网络前缀越短，其地址块包含的地址数就越多。

::: tip

注意地址数和实际可指派的地址数的区别

:::

![](252.png)

![](253.png)

![](254.png)

#### 路由聚合

因为一个CIDR地址块中有很多地址，所以在路由表中就可利用CIDR地址块来查找目的网络。

这种地址的聚合称为路由聚合，也称构成超网，它使得路由表中的一个项目可以表示多个原来传统分类地址的路由，有利于减少路由器之间的信息交换，进而提高网络性能。

![](255.png)

网络前缀越长，地址块越小，路由越具体；因此若路由器查表转发分组时发现有多条路由条目匹配，则选择网络前缀最长的那条路由条目，这称为==最长前缀匹配==，因为这样的路由更具体。

![](256.png)

![](257.png)

![](258.png)

![](259.png)

![](260.png)

![](382.png)

![](383.png)

### 子网划分应用举例

通常有两类划分子网的方法：采用定长的子网掩码，采用变长的子网掩码。

#### 定长子网掩码

![](261.png)

![](263.png)

![](264.png)

![](265.png)

![](266.png)



#### 变长子网掩码

![](262.png)

![](267.png)

![](268.png)

![](269.png)

::: tip 每个子块的位置不能随便选取的原因

每个子网的最小地址只能选取主机号全0的地址，最大地址只能选取主机号全1的地址。

在上图中，如果218.75.230.0000 0100(218.75.230.4)作为某个网络的起点，那么该网络只有4个地址。但此时1，2，3，4网络所需地址都大于4，即218.75.230.4无法作为1，2，3，4网络的起点。

:::

![](380.png)

![](381.png)



## IPv4数据报

IPv4数据报的首部格式及其内容是实现IPv4协议各种功能的基础。在TCP/IP标准中，各种数据格式常常以32比特（即4字节）为单位来描述。

### 格式

一个IP分组（或称IP数据报）由首部和数据部分组成。首部前一部分的长度固定，共20B，是所有IP分组必须具有的。在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。

![](278.png)

- ==版本==

  **占4位**。指IP的版本，==IPv4数据报中该字段值是4==。

- ==首部长度==

  **占4位**。以==4B为单位==，最大可表示的首部长度为60B（15x4B）。最常用的首部长度是20B（5x4B），该字段值是5，此时不使用任何可选字段。

- ==总长度==

  **占16位**。指==首部和数据之和的长度==，==单位为字节==，因此数据报的最大长度为2^16^-1=65535B（但很少传输这么长的IPv4数据报）。

  **以太网帧的最大传送单元（MTU）为1500B（包含首部和数据）**，因此当一个IP数据报封装成帧时，==数据报的总长度（首部加数据）一定不能超过下面的数据链路层的MTU值==。

  ![](279.png)

- ==标识==

  **占16位**。属于==同一个IPv4数据报的各分片数据报应该具有相同的标识==。

  IP软件会维持一个计数器，每产生一个IPv4数据报，计数器值就加1，并将此值赋给标识字段。但它并不是“序号”（因为IP是无连接服务）。

  当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确地重装成原来的数据报。

- ==标志(Flag)==

  **占3位**。

  - 标志字段的最低位为==(More Fragment)MF==，MF=**1表示本分片后面还有分片**，MF=**0表示本分片后面没有分片**。
  - 标志字段的中间位为==(Don’t Fragment)DF==，DF=**1表示不允许分片**，DF=**0表示允许分片**。
  - 最高位为保留位，必须设置为0。

- ==片偏移==

  **占13位**。它指出较长的数据报在分片后，某片在原数据报中的相对位置，片偏移==以8B为偏移单位==，且==值必须为整数==。

  **除最后一个分片外，每个分片的长度一定是8B的整数倍**，否则，会造成其相邻后续分片数据报的片偏移不是整数。。

- ==生存时间==(==TTL==, Time To Live)

  **占8位**。数据报在网络中==可通过的路由器数的最大值==，**标识数据报在网络中的寿命，以确保数据报不会永远在网络中循环**。

  路由器在转发数据报前，先将TTL减1。若TTL被减为0，则该数据报必须丢弃。

  ![](284.png)

- ==协议==

  **占8位**。指出此数据报携带的数据使用何种协议，即==数据报的数据部分应上交给哪个协议进行处理==，如TCP、UDP等。

- ==首部检验和==

  **占16位**。它==只检验数据报的首部==，但==不包括数据部分==。这是因为数据报每经过一个路由器，都要重新计算首部检验和（有些字段，如生存时间、总长度、标志、片偏移、源/目的地址都可能发生变化），不检验数据部分可减少计算的工作量。

  计算检验和的方法是先把数据报的首部划分为许多16比特的序列，用反码算术运算把所有16比特相加后，将得到的和的反码写入检验和字段。

  接收方的网络层发现检验和出错后，就**丢弃收到的数据报**，但**不会发送差错报文**。

- ==源地址字段==

  占4B，标识发送方的IP地址。

- ==目的地址字段==

  占4B，标识接收方的IP地址。

- 可选字段

  长度从1字节到40字节不等，用来支持排错、测量以及安全措施等功能。实际上，可选字段很少被使用。

- 填充

  用来确保IPv4数据报的首部长度是4字节的整数倍，使用全0进行填充。

  当首部长度（20字节固定部分+可变部分）的长度不是4字节整数倍时，填充相应数量的全0字节，以确保IPv4数据报的首部长度是4字节的整数倍。



### 分片

![](280.png)

一个链路层数据帧==能承载的最大数据量==称为==最大传送单元(MTU)==。

因为IP数据报被封装在链路层的帧中，因此链路层的MTU严格地限制了IP数据报的长度，而且在IP数据报的源与目的地路径上的各段链路可能使用不同的链路层协议，有不同的MTU。

当IP数据报的总长度大于链路MTU时，就需要将IP==数据报中的数据==分装在多个较小的IP数据报中，这些较小的数据报称为片。

![](281.png)

![](282.png)

![](283.png)

### 发送

IP数据报的发送和转发过程包含以下两个过程：主机发送IP数据报，路由器转发IP数据报。

![](286.png)

![](285.png)

若目的主机不在子网中，则将该数据发送到默认网关，由网关（路由器）将其转发到其他网络，进一步寻找目的主机。

### 转发

当分组到达路由器后，路由器根据目的IP地址的网络前缀来查找转发表，确定下一跳应当到哪个路由器。

因此，在转发表中，每条路由必须有：目的网络地址，下一跳地址。

这样，IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次间接交付），当到达最后一个路由器时，才试图向目的主机进行直接交付。

采用CIDR编址时，若一个分组在转发表中可以找到多个匹配的前缀，则应当使用最长前级匹配。

**为了更快地查找转发表**，可以按照前缀的长短，将前缀最长的排在第1行，**按前缀长度的降序排列**。这样，从第1行最长的开始查找，只要检索到匹配的，就不必再继续查找。

---

综上所述，归纳出路由器执行的分组转发算法如下：

1. 从收到的IP分组的首部提取目的主机的IP地址。
2. 若查找到特定主机路由，则按照这条路由的下一跳转发分组；否则从转发表中的下一条开始检查，执行步骤3）。
3. 将这一行的子网掩码与目的地址逐位“与”。若运算结果与本行的前缀匹配，则查找结束，按照“下一跳”指出的进行处理（或者直接交付本网络上的目的主机，或通过指定接口发送到下一跳路由器）。否则，若转发表还有下一行，则对下一行进行检查，直到转发表没有下一行。
4. 若转发表中有一个默认路由，则把分组传送给默认路由；否则，报告转发分组出错。

![](287.png)

![](288.png)

![](289.png)

![](290.png)

值得注意的是，转发表（或路由表）并没有给分组指明到某个网络的完整路径（即先经过哪个路由器，然后经过哪个路由器等）。转发表指出，到某个网络应当先到某个路由器（即下一跳路由器），到达下一跳路由器后，再继续查找其转发表，知道再下一步应当到哪个路由器。这样一步一步地查找下去，直到最后到达目的网络。

得到下一跳路由器的IP地址后，并不是直接将该地址填入待发送的数据报，而是将该IP地址转换成MAC地址（通过ARP），将此MAC地址填入MAC帧首部，然后根据这个MAC地址找到下一跳路由器。在不同网络中传送时，MAC帧的源地址和目的地址要发生变化。

## 网络地址转换(NAT)

网络地址转换(NetworkAddressTranslation, NAT)是指通过**将专用网络地址如（如Intranet）转换为公用地址（如Interme），从而对外隐藏内部管理的IP地址**。

它使得整个专用网只需要一个全球IP地址就可与互联网连通，因为专用网本地IP地址是可重用的，所以NAT大大节省了IP地址的消耗。同时，它隐藏了内部网络结构，从而降低了内部网络受到攻击的风险。

此外，为了网络安全，划出了部分IP地址为私有IP地址。私有IP地址只用于LAN，不用于WAN连接（因此==私有IP地址不能直接用于Intermnet==，必须通过网关利用NAT把私有IP地址转换为Intermet中合法的全球IP地址后才能出现在Internet上），并且允许私有IP地址被LAN重复使用。这有效地解决了IP地址不足的问题。

在互联网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发。这种采用私有IP地址的互联网络称为专用互联网或本地互联网。**私有IP地址也称可重用地址**。

私有IP地址网段：

- 10.X.X.X
- 172.16.XX ~ 172.31.X.X
- 192.168.X.X ~ 192.168.X.X

### 基本的NAT方法

使用NAT时需要在专用网连接到互联网的路由器上安装NAT软件，**NAT路由器至少有一个有效的外部全球IP地址**。当使用本地地址的主机和外界通信时，NAT路由器使用NAT转换表进行本地IP地址和全球IP地址的转换。

![](342.png)

![](343.png)

### 网络地址与端口号转换方法

将NAT和运输层端口号结合使用，称为**网络地址与端口号转换**(Network Address and Port Translation，NAPT)

由于目前绝大多数基于TCP/IP协议栈的网络应用，都使用运输层的传输控制协议TCP或用户数据报协议UDP，为了更加有效地利用NAT路由器中的全球IP地址，现在常将NAT转换和运输层端口号结合使用。

这样，只需要一个全球IP地址，就可让多台主机同时访问互联网。

![](344.png)

![](345.png)

::: tip

普通路由器在转发IP分组时，其源IP地址和目的IP地址都不会改变。而NAT路由器在转发IP分组时，一定要更换其IP地址（转换源IP地址或目的IP地址）。

普通路由器仅工作在网络层，而NAT路由器转发数据报时需要查看和转换传输层的端口号。

:::

### 特点

NAT（和NAPT）的一个重要特点就是==通信必须由专用网内部发起==，因此拥有内部专用地址的主机不能直接充当因特网中的服务器。

![](346.png)

## 地址解析协议(ARP)

### IP地址与MAC地址

IP地址是网络层及网络层之上使用的地址，它是分层式的。

![](270.png)

因为路由器的隔离，IP网络中无法通过广播MAC地址来完成跨网络的寻址，所以在网络层只使用IP地址来完成寻址。

![](271.png)

- 虽然在IP数据报首部中有源IP地址，但**路由器只根据目的IP地址进行转发**。
- 在局域网的链路层，只能看见MAC帧。IP数据报被封装在MAC帧中。通过路由器转发时，IP数据报在每个网络中都被路由器解封装和重新封装，其==MAC帧首部中的源地址和目的地址会不断改变==。这也决定了**无法使用MAC地址跨网络通信**。

::: tip

==路由器==因为互连多个网络，所以它==不仅有多个IP地址，而且有多个硬件地址==。

:::

寻址时，每个路由器依据其路由表（依靠路由协议生成）选择到目标网络（即主机号全为0的网络地址）需要转发到的下一跳（路由器的物理端口号或下一网络地址），而IP数据报通过多次路由转发到达目标网络后；改为在目标局域网中通过数据链路层的MAC地址以广播方式寻址。这样可以提高路由选择的效率。

### 地址解析协议

无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址。所以需要一种方法来完成IP地址到MAC地址的映射，这就是地址解析协议(AddressResolutionProtocol, ARP)。

每台主机都设有一个**ARP高速缓存**，用来存放本局域网上各主机和路由器的**IP地址到MAC地址的映射表**，称**ARP表**。使用ARP来动态维护ARP表。

![](272.png)

==ARP工作在网络层==，其工作原理如下：

1. 主机A欲向本局域网上的某台主机B发送IP数据报时，先在其ARP高速缓存中查看有无主机B的IP地址。

   - 若有，则可以查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址。
   - 若没有，则通过使用==目的MAC地址为FF-FF-FF-FF-FF-FF的帧==来封装并==广播ARP请求分组（广播发送）==，使同一个局域网里的所有主机都收到此ARP请求。

   ![](273.png)

2. 主机B收到该ARP请求后，向主机A发出==ARP响应分组（单播发送）==，分组中包含主机B的IP地址与MAC地址的映射关系。

   ![](274.png)

3. 主机A收到ARP响应分组后就将此映射写入ARP缓存，然后按查询到的硬件地址发送MAC帧。

==ARP因为“看到了”IP地址，所以它工作在网络层，而NAT路由器因为“看到了”端口，所以它工作在传输层==。

![](275.png)

ARP用于==解决同一局域网上==的主机或路由器的IP地址和硬件地址的映射问题。

若目的主机和源主机不在同一个局域网上，则要通过ARP找到本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络，剩下的工作就由下一个网络来做。

![](276.png)

---

使用ARP的4种典型情况：

1. 发送方是主机（H1），要把IP分组发送到本网络上的另一台主机（H2）。这时H1在网1用ARP找到目的主机H2的硬件地址。

2. 发送方是主机（H1），要把IP分组发送到其他网络上的一台主机（H4）。这时H1用ARP找到与网1连接的路由器R1的硬件地址（默认网关），剩下的工作由R1来完成。

   开始在H1和R1之间传送时，MAC帧首部中的源地址是H1的MAC地址，目的地址是L1的硬件地址，路由器R1收到此MAC帧后，在数据链路层，要丢弃原MAC的首部和尾部。这时首部中的源地址和目的地址分别为L2和L3的MAC地址。路由器R2收到此帧后，再次更换MAC帧的首部和尾部，首部中的源地址和目的地址分别变为L4和H4的MAC地址。MAC帧首部的这种变化，在上面的IP层中是看不见的。

3. 发送方是路由器（R1），要把IP分组转发到与R1连接的网络（网2）上的一台主机（H3）。这时R1在网2用ARP找到目的主机H3的硬件地址。

4. 发送方是路由器（R1），要把IP分组转发到网3上的一台主机（H4）。这时R1在网2用ARP找到与网2连接的路由器R2的硬件地址，剩下的工作由R2来完成。

![](277.png)

从IP地址到硬件地址的解析是自动进行的，主机的用户并不知道这种地址解析过程。只要主机或路由器和本网络上的另一个已知IP地址的主机或路由器进行通信，ARP就自动地将这个IP地址解析为数据链路层所需要的硬件地址。

1000 1000

1111 0000

## 网际控制报文协议(ICMP)

为了有效地转发IP数据报和提高交付成功的机会，在网络层使用了网际控制报文协议(IntermetControl MessageProtocol, ICMP)，让==主机或路由器==**报告差错和异常情况**。

ICMP报文==被封装在IP数据报中发送==，但ICMP不是高层协议，而是==网络层的协议==。

ICMP报文有两种，即==ICMP差错报告报文==和==ICMP询问报文==。

![](293.png)

### 差错报告报文

ICMP差错报告报文用于目标主机或到目标主机路径上的路由器，向源主机报告差错和异常情况。共有以下**5种常用的类型**：

1. ==终点不可达==

   当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。

   ![](294.png)

2. ==源点抑制==

   当路由器或主机因为拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。

   ![](295.png)

   ![](296.png)

3. ==时间超过==

   当路由器收到生存时间（TTL）为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。

   ![](297.png)

   当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。

4. ==参数问题==

   当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。

   ![](298.png)

5. ==改变路由（重定向）==

   路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

   ![](299.png)

   ![](300.png)

---

对于以下几种情况，不应发送ICMP差错报告报文：

1. 对**ICMP差错报告报文**，不再发送ICMP差错报告报文。
2. 对第一个分片的数据报片的**所有后续数据报片**，都不发送ICMP差错报告报文。
3. 对具**有多播地址**的数据报，都不发送ICMP差错报告报文。
4. 对具**有特殊地址**（如127.0.0.0或0.0.0.0）的数据报，不发送ICMP差错报告报文。

### 询问报文

ICMP询问报文常用的2种类型：

- **回送请求**和**回答报文**：用来测试目的站是否可达以及了解其有关状态。
- **时间戳请求**和**回答报文**：用来进行时钟同步和测量时间。

### ICMP应用

![](301.png)

ICMP的两个常见应用是**分组网间探测**==PING==（用来测试两台主机之间的连通性）和**跟踪路由**==Traceroute==（UNIX中的名字，在Windows中是Tracert，可以用来跟踪分组经过的路由）。

- ==PING工作在应用层==，使用了ICMP**回送请求和回答报文**。

- ==Traceroute工作在网络层==，使用了ICMP**时间超过报文**。

  ![](302.png)

  ![](303.png)

  ![](304.png)

# 路由算法

路由选择协议的核心是路由算法，即需要何种算法来获得路由表中的各个项目。

路由算法的目的很简单：给定一组路由器及连接路由器的链路，路由算法要找到一条从源路由器到目的路由器的“最佳”路径。

通常，“最佳”路径是指具有最低费用的路径。

## 静态路由与动态路由

路由器转发分组是通过路由表转发的，而路由表是通过各种算法得到的。

从能否随网络的通信量或拓扑自适应地进行调整变化来划分，路由算法可以分为如下两大类。

1. ==静态路由算法==

   指由网络管理员**手工配置**每一条路由。

   静态路由算法的特点是**简单和开销较小**，但**不能及时适应网络状态的变化**，==适用于简单的小型网络==。

2. ==动态路由算法==

   根据网络流量负载和拓扑结构的变化来动态调整自身的路由表。

   动态路由算法能较好地适应网络状态的变化，但实现复杂，开销也大，适用于==较复杂的大网络==。

   常用的动态路由算法可分为两类：**距离-向量路由算法**和**链路状态路由算法**。

![](308.png)

## 静态路由配置

静态路由配置是指用户或网络运维人员使用路由器的相关命令给路由器人工配置路由表。

![](307.png)

### 特殊路由

路由表存在**两种特殊的路由**：

1. ==特定主机路由==

   对==特定目的主机的IP地址==专门指明一个路由，以**方便网络管理员控制和测试网络**。

   若特定主机的IP地址是a.b.c.d，则转发表中对应项的目的网络是a.b.c.d/32。/32表示的子网掩码没有意义，但这个特殊的前缀可以用在转发表中。

   ![](306.png)

2. ==默认路由==

   用特殊前缀==0.0.0.0/0==表示默认路由，全0掩码和任何目的地址进行按位与运算，结果必然为全0，即必然和前缀0.0.0.0/0相匹配。只要**目的网络是其他网络（不在转发表中），就一律选择默认路由**。

   ==默认路由通常用于路由器到互联网的路由==，互联网包括无数的网络集合，不可能在路由表项中一一列出，因此只能采用默认路由的方式。

   ![](305.png)

## 动态路由算法

### 距离-向量路由算法

![](323.png)

### 链路状态路由算法

**链路状态**是指本路由器都**和哪些路由器相邻**，以及**相应链路的代价**。“代价”用来表示费用、距离、时延和带宽等，这些都由网络管理人员来决定。

![](326.png)

链路状态算法要求==每个结点都具有全网拓扑结构图==（这个拓扑结构图在全网范围内是一致的），它们执行下列两项任务：

- 主动测试所有相邻结点的状态；
- 定期地将链路状态传播给所有其他结点。

因此每个结点都知道全网共有多少个结点、哪些结点是相连的、其代价是多少等，于是每个结点都可使用==Dijkstra最短路径算法==计算出到达其他结点的最短路径。

在链路状态算法中，结点每收到一个链路状态报文，便用其更新自已的网络状态“视野图”，一旦链路状态发生变化，就使用Dijkstra算法重新计算到达所有其他结点的最短路径。

因为一个结点的链路状态只涉及相邻结点的连通状态，而与整个互联网的规模并无直接关系，所以链路状态算法==适用于大型的或路由信息变化聚敛的互联网环境==。

链路状态算法的主要优点是

- 每个结点都使用同样的链路状态数据独立地计算路径，而不依赖中间结点的计算；
- 链路状态报文不加改变地传播，因此采用该算法易于查找故障。
- 当一个结点从所有其他结点接收到报文时，它就在本地立即计算出正确的路径，保证一步汇聚。
- 因为链路状态报文仅运载来自单个结点关于直接链路的信息，其大小与网络中的结点数目无关，所以链路状态算法比距离-向量算法有更好的规模可伸展性。
- 链路状态算法具有==快速收敛==的优点，它能在网络拓扑发生变化时，立即进行路由的重新计算，并及时向其他路由器发送最新的链路状态信息，使得各路由器的链路状态表能够尽量保持一致。

---

两种路由算法的比较：

- 在距离-向量算法中，每个结点仅与它的直接邻居交谈，向它的邻居发送自己的路由表，其大小取决于网络中的结点数目，代价较大。
- 在链路状态算法中，每个结点通过广播的方式与所有其他结点交谈，但它只告诉它们与它直接相连的链路的费用。

# 路由选择协议

互联网采用的是自适应的、分布式路由选择协议。

因为互联网的规模非常大，许多联网单位不愿让外界了解自己单位网络的布局细节，所以互联网采用==分层次的路由选择协议==。

为此，可以把整个互联网划分为许多较小的自治系统。自治系统是在单一技术管理下的一组路由器，这些路由器使用一种AS内部的路由选择协议和共同的度量。一个AS对其他AS表现出的是一个单一的和一致的路由选择策略。

![](309.png)

这样，互联网就把路由选择协议划分为两大类。

- ==内部网关协议==(Interior Gateway Protocol, ==IGP==)

  内部网关协议即在一个自治系统内部使用的路由选择协议，它与在互联网中的其他自治系统选用什么路由选择协议无关。

  目前这类路由选择协议使用得最多，如RIP和OSPF。

- ==外部网关协议==(External Gateway Protocol, ==EGP==)

  若源主机和目的主机处在不同的自治系统中，则当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议。

  目前使用最多的外部网关协议是BGP-4。

自治系统之间的路由选择也称域间路由选择，自治系统内部的路由选择也称域内路由选择。

每个自治系统自己决定在本自治系统内部运行哪个内部网关协议。但每个自治系统都有一个或多个路由器除运行本系统的内部网关协议外，还要运行外部网关协议。

![](310.png)

::: tip

1. 外部网关协议EGP和内部网关协议IGP只是路由选择协议的分类名称，而不是具体的路由选择协议。
2. 外部网关协议和内部网关协议名称中使用的是“网关”这个名词，是因为在因特网早期的RFC文档中，没有使用“路由器”而使用的是“网关”这一名词。

:::

## 内部网关协议

### 路由信息协议(RIP)

路由信息协议(Routing Information Protocol, ==RIP==)是内部网关协议IGP中最先得到广泛应用的协议。RIP是一种分布式的==基于距离向量的==路由选择协议。

#### 规定

1. 网络中的每个路由器都要维护从它自身到其他每个目的网络的距离记录，即距离向量。

2. RIP使用==跳数==(Hop Count)来衡量到达目的网络的距离。

   规定从一路由器到**直接连接的网络的距离定义为1**；而**每经过一个路由器**，距离就加1。

   RIP允许==一条路径最多只能包含15个路由器==。因此**距离等于16时表示网络不可达**。可见RIP只适用于小型互联网。

   ![](311.png)

   距离向量路由可能会出现环路的情况，规定路径上的**最高跳数的目的是为了防止分组不断在环路上循环，减少网络拥塞的可能性**。

3. RIP认为==好的路由==就是它==通过的路由器数目少==，即距离短或跳数少。

   ![](312.png)

4. 每个路由表项都有三个关键字段：目的网络，距离，下一跳路由器地址。

#### 特点

RIP的每个路由器都要不断与其他路由器交换信息，下面三个特点非常重要。

1. **和谁交换信息**

   ==仅和直接相邻的路由器==交换信息。

   ![](313.png)

2. **交换什么信息**

   交换的信息是本路由器所知道的全部信息，即自己的==路由表==。

3. **何时交换信息**

   按==固定的时间间隔==（如30秒）交换路由信息。当==网络拓扑发生变化时==，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

#### 基本工作过程

路由器刚开始工作时，只知道自己到直接相连的几个网络的距离为1。

每个路由器仅和相邻路由器周期性地交换并更新路由信息。

所谓==收敛==，是指当路由环境发生变化后，各**路由器调整自己的路由表以适应网络拓扑结构的变化**，最终**达到稳定状态**（路由表与网络拓扑状态保持一致）。**收敛越快，路由器就能越快适应网络拓扑结构的变化**。

![](314.png)

![](315.png)

#### 距离向量算法

![](316.png)

![](317.png)

![](318.png)

![](319.png)

![](320.png)

![](321.png)

![](322.png)

若180秒（RIP默认超时时间）还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达的路由器，即把距离设置为16（距离为16表示不可达）。

 

#### 优缺点

![](325.png)

---

优点：

1. **实现简单、开销小、收敛过程较快**。
2. 若一个路由器发现了更短的路由，则这种更新信息就传播得很快，在较短时间内便可被传至所有路由器，俗称“==好消息传播得快==”。

---

缺点：

1. RIP限制了网络的规模，它能使用的**最大距离为15**（16表示不可达）。

2. 路由器之间**交换**的是路由器中的**完整路由表**，因此**网络规模越大，开销也越大**。

3. 当网络出现故障时，路由器之间需反复多次交换信息才能完成收敛，要经过较长时间才能将故障消息传送到所有路由器（即慢收敛现象），俗称“==坏消息传播得慢==”。

   ![](324.png)

### 开放最短路径优先协议(OSPF)

开放最短路径优先(Open Shortest Path First, OSPF)协议是==使用分布式链路状态路由算法==的典型代表，也是内部网关协议(IGP)的一种。

#### 特点

1. OSPF向本自治系统中==所有路由器发送信息==。

   而RIP仅仅向自己**相邻的**几个路由器发送信息。

2. 发送的信息是==与本路由器相邻的所有路由器的链路状态==，但这只是**路由表的一部分**。

   而**在RIP中**，发送的信息是本路由器所知道的全部信息，即**整个路由表**。

3. ==只有当链路状态发生变化时==，路由器才用洪泛法向所有路由器发送此信息，并且更新过程收敛得快，不会出现RIP“坏消息传得慢”的问题。

   而在RIP中，不管网络拓扑是否发生变化，路由器之间都要**定期**交换路由表的信息。

4. ==OSPF是网络层协议==，它不用UDP或TCP，而==直接用IP数据报==传送（其IP数据报首部的协议字段为89）。

   而==RIP是应用层协议==（但其核心功能是路由选择，属于网际层），它==在传输层使用UDP==。

   用UDP传送是指将该信息作为UDP报文的数据部分，而直接使用IP数据报传送是指将该信息直接作为IP数据报的数据部分。RIP报文是作为UDP数据报的数据部分。

5. OSPF允许对每条路由设置成不同的代价，对于不同类型的业务可计算出不同的路由。

6. 若到同一个目的网络有多条相同代价的路径，则可将通信量分配给这几条路径。

7. OSPF分组具有鉴别功能，从而保证仅在可信赖的路由器之间交换链路状态信息。

8. OSPF支持可变长度的子网划分和无分类编址CIDR。

9. 每个链路状态都带上一个32位的序号，序号越大，状态就越新。

#### 工作原理

因为各路由器之间频繁地交换链路状态信息，所以所有路由器最终都能建立一个链路状态数据库，即全网的拓扑结构图。然后，每个路由器利用链路状态数据库中的数据，使用Dijkstra算法计算自己到达各目的网络的最优路径，构造出自已的路由表。此后，当链路状态发生变化时，每个路由器重新计算到达各目的网络的最优路径，构造出新的路由表。

::: tip

虽然使用Dijkstra算法能计算出完整的最优路径，但==路由表中不会存储完整路径，而只存储“下一跳”==（只有到了下一跳路由器，才能知道再下一跳应当怎样走）。

:::

为了使OSPF**能够用于规模很大的网络**，OSPF**将一个自治系统再划分为若干更小的范围，称为区域**。域之间通过区域边界路由器互连。

**划分区域的好处是**，将**利用洪泛法交换链路状态信息的范围局限在每个区域而非整个自治系统**，从而**减少了整个网络上的通信量**。

![](329.png)

OSPF协议将一个自治域划分成若干域，有一种特殊的域称为主干区域。主干区域中，用于连接主干区域和其他下层区域的路由器称为区域边界路由器。只要是在主干区域中的路由器，就都称为主干路由器，因此主干路由器可以兼作区域边界路由器。

#### 工作过程

OSPF共有以下五种分组类型：

1. **问候分组**：用来发现和维持邻站的可达性。
2. **数据库描述分组**：向邻站给出自已的链路状态数据库中的所有链路状态项目的摘要信息。
3. **链路状态请求分组**：向对方请求发送某些链路状态项目的详细信息。
4. **链路状态更新分组**：用洪泛法对全网更新链路状态，它是OSPF最核心的部分。
5. **链路状态确认分组**：对链路更新分组的确认。

![](327.png)

在网络中通常传送的OSPF分组大多是问候分组。两个相邻路由器通常每隔10秒要交换一次问候分组，以便知道哪些站可达。若有40秒没有收到某个相邻路由器发来的问候分组，则认为该相邻路由器不可达，应立即修改链路状态数据库，并重新计算路由表。

![](328.png)

在路由器刚开始工作时，OSPF让每个路由器使用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。然后，路由器使用链路状态请求分组，向对方请求发送自已所缺少的某些链路状态项目的详细信息。经过一系列的这种分组交换，就建立了全网同步的链路数据库。

在网络运行的过程中，只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态。其他路由器在收到更新分组后要发送确认。

为了确保链路状态数据库与全网的状态保持一致，OSPF还规定每隔一段时间（如30分钟）要刷新一次数据库中的链路状态。因为一个路由器的链路状态只涉及与相邻路由器的连通状态，与整个网络的规模并无直接关系，所以==当互联网规模很大时，OSPF要比RIP好得多==。


## 外部网关协议

### 边界网关协议(BGP)

#### 概念

边界网关协议(BorderGatewayProtocol, BGP)是不同自治系统AS的路由器之间交换路由信息的协议，是一种外部网关协议。边界网关协议BGP常用于互联网的网关之间。

内部网关协议主要是设法使数据报在一个AS中尽可能有效地从源站传送到目的站。在一个AS内部也不需要考虑其他方面的策略。然而BGP使用的环境却不同，主要原因如下：

1. 互联网的规模太大，使得AS之间路由选择非常困难，每个主干网路由器表中的项目数都非常庞大。对于AS之间的路由选择，要寻找最佳路由是很不现实的。

   ![](330.png)

2. AS之间的路由选择必须考虑政治、安全或经济等有关因素。

   ![](331.png)

自治系统之间的路由选择协议应当允许使用多种路由选择策略。这些策略包括政治、经济、安全等，它们都是由网络管理人员对每一个路由器进行设置的。但这些策略并不是自治系统之间的路由选择协议本身。

BGP只能是**力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子）**，而==并非要寻找一条最佳路由==。

BGP采用的是==路径向量路由选择协议==，它与距离向量协议（如RIP）和链路状态协议（如OSPF）都有很大的区别。

==BGP是应用层协议==，它是==基于TCP的==。

#### 工作原理

1. 配置BGP时，每个AS的管理员要**选择至少一个路由器**，作为该AS的“==BGP发言人==”，**BGP发言人往往就是BGP边界路由器**。

   ![](332.png)

2. 一个BGP发言人与其他AS中的BGP发言人要交换路由信息，就要**先建立TCP连接**，然后在此连接上交换BGP报文以**建立BGP会话**，再利用BGP会话**交换路由信息**。

   使用TCP连接交换路由信息的两个BGP发言人，彼此成为对方的==邻站==或==对等站==。

   每个BGP发言人除了必须运行BGP外，还必须运行该AS所用的内部网关协议，如OSPF或RIP。

   ![](333.png)

3. BGP所交换的==网络可达性信息==，就是要**到达某个网络所要经过的一系列自治系统**，即**到达某个网络所经过的路径**。当BGP发言人互相交换网络可达性信息后，各BGP发言人就根据所用的策略，从收到的路由信息中找出到达各自治系统的较好路由。

   ![](334.png)

   ![](335.png)

#### 特点

1. BGP交换路由信息的结点数量级是AS个数的数量级，这要比这些AS中的网络数少很多。
2. 寻找一条较好的路径，取决于找准正确的BGP发言人，而每个AS中BGP发言人（或边界路由器）的数目是很少的。这样就使得AS之间的路由选择不致过分复杂。
3. BGP支持CIDR，因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。
4. 当BGP刚运行时，BGP的邻站交换整个BGP路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销方面都有好处。

#### 报文

1. **打开报文**：用来与相邻的另一个BGP发言人建立关系，使通信初始化。
2. **更新报文**：用来通知某一路由的信息，以及列出要撤销的多条路由。
3. **保活报文**：用来周期性地证实邻站的连通性。
4. **通知报文**：用来发送检测到的差错。

![](336.png)

若一个BGP发言人想与另一个AS的BGP发言人建立邻站关系，则要向对方发送Open报文，若对方接受这种邻站关系，则用Keepalive报文响应。

邻站关系一旦建立，就要继续维持这种关系。为此，这两个BGP发言人彼此要周期性地交换Keepalive报文（一般每隔30秒）。Keepalive报文只有19B，因此不会造成网络上太大的开销。

Update报文是BGP的核心内容，BGP发言人可以用Update报文撤销它曾经通知过的路由，也可以宣布增加新的路由。

## 三种路由协议比较

从实现功能（路由选择）的角度看，这三个路由选择协议都属于网络层。

从数据包按网络体系结构逐层封装的角度看，RIP和BGP属于应用层，OSPF属于网络层。

![](338.png)

![](337.png)

# IP多播

## 概念

多播是让源主机一次发送的单个分组可以抵达用一个组地址标识的若干目的主机，即==一对多的通信==。在互联网上进行的多播，称为IP多播。

与单播相比，在一对多的通信中，多播可大大==节约网络资源==。

多播需要路由器的支持才能实现，能够运行多播协议的路由器称为多播路由器。

![](347.png)

## 多播地址

多播数据报的==源地址==是==源主机的IP地址==，==目的地址==是==IP多播地址==。IP多播地址就是IPv4中的==D类地址==。每个D类IP地址标志一个多播组，**一台主机可以随时加入或离开一个多播组**。

![](348.png)

多播数据报和一般的IP数据报的区别是，前者使用D类IP地址作为目的地址，并且首部中的协议字段值是2，表明使用IGMP协议。

需要注意的是：

1. 多播数据报也是“尽最大努力交付”，不提供可靠交付。
2. 多播地址只能用于目的地址，而不能用于源地址。
3. 对多播数据报不产生ICMP差错报文。

---

IP多播可以分为两种：

1. 只在**本局域网**上进行**硬件多播**；
2. 在**互联网**的范围内进行**多播**。

目前大部分主机都是通过局域网接入互联网的。因此，在互联网上进行**多播的最后阶段，还是要把多播数据报在局域网上用硬件多播交付给多播组的所有成员**。

多播机制仅应用于UDP，它能将报文同时发送给多个接收者。而TCP是一个面向连接的协议，它意味着分别运行在两台主机的进程之间存在一条连接，因此会一对一地发送。

## 硬件多播

由于MAC地址（也称为硬件地址）有多播MAC地址这种类型，因此只要把**IP多播地址映射成多播MAC地址**，即可将IP多播数据报封装在局域网的MAC帧中，而MAC帧首部中的目的MAC地址字段的值，就设置为由IPv4多播地址映射成的多播MAC地址。这样，可以很方便地**利用硬件多播来实现局域网内的IP多播**。

![](349.png)

因特网号码指派管理局IANA，将01-00-5E-00-00-00到01-00-5E-7F-FF-FF的多播MAC地址，用于映射IPv4多播地址。

![](350.png)

![](351.png)

![](352.png)

![](354.png)

![](353.png)

## 网际组管理协议(IGMP)

路由器要获得多播组的成员信息，需要利用网际组管理协议(InternetGroupManagementProtocol，IGMP)。

IGMP是让连接到本地局域网上的多播路由器，**知道本局域网上是否有主机参加或退出了某个多播组**。IGMP并不是在互联网范围内对所有多播组成员进行管理的协议。IGMP不知道IP多播组包含的成员数，也不知道这些成员分布在哪些网络上。

IGMP报文被封装在IP数据报中传送，但它也向IP提供服务。因此不把IGMP视为一个单独的协议，而视为整个网际协议IP的一个组成部分。IGMP的工作可分为两个阶段。

第一阶段：当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要成为该组的成员。本地的多播路由器收到IGMP报文后，还要利用多播路由选择协议，把这种组成员关系转发给互联网上的其他多播路由器。第二阶段：组成员关系是动态的。本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否仍继续是组的成员。只要对某个组有一台主机响应，多播路由器就认为这个组是活跃的。但一个组在经过几次探询后仍然没有一台主机响应，多播路由器就认为本网络上的主机都已离开了这个组，因此就不再把这个组的成员关系转发给其他的多播路由器。

## 多播路由选择协议

仅使用IGMP并不能在因特网上进行IP多播。连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把IP多播数据报用最小的代价传送给所有的多播组成员，这就需要使用多播路由选择协议。

多播路由选择实际上就是要**找出以源主机为根结点的多播转发树，其中每个分组在每条链路上只传送一次**（即在多播转发树上的路由器不会收到重复的多播数据报）。

![](355.png)

不同的多播组对应于不同的多播转发树；同一个多播组，对不同的源点也会有不同的多播转发树。

# 移动IP

移动IP技术是指**移动站以固定的IP地址实现跨越不同网络的漫游功能**，并保证基于IP的网络权限在漫游过程中不发生任何改变。

移动IP的目标是把分组自动地投递给移动站。一个移动站是把其连接点从一个网络或子网改变到另一个网络或子网的主机。

移动IP定义了三种功能实体：

1. **移动结点**：具有永久IP地址的移动主机。
2. **本地代理**：也称**归属代理**，通常就是连接在归属网络（原始连接到的网络）上的路由器。
3. **外地代理**：通常就是连接在被访网络（移动到另一地点所接入的网络）上的路由器。

值得注意的是，某用户将笔记本关机后从家里带到办公室重新上网，在办公室能很方便地通过DHCP自动获取新的IP地址。虽然笔记本移动了，更换了地点及所接入的网络，但这并不是移动IP。

但是，若我们需要在移动中进行TCP传输，则在移动站漫游时，应一直保持这个TCP连接，否则移动站的TCP连接就会断断续续。可见，若要使移动站在移动中的TCP连接不中断，就必须使笔记本的IP地址在移动中保持不变。这就是移动IP要研究的问题。

---

在移动IP中，每个移动站都有一个原始地址，即永久地址（或归属地址），移动站原始连接的网络称为归属网络。永久地址和归属网络的关联是不变的。

归属代理通常是连接到归属网络上的路由器，然而它实现的代理功能是在应用层完成的。当移动站移动到另一地点，所接入的外地网络也称被访网络。被访网络中使用的代理称为外地代理，它通常是连接在被访网络上的路由器。

外地代理有两个重要功能：

- 要为移动站创建一个临时地址，称为转交地址。转交地址的网络号显然和被访网络一致。
- 及时把移动站的转交地址告诉其归属代理。

---

移动IP的基本通信流程如下：

1. 移动站A在归属网络时，按传统的TCP/IP方式进行通信。

2. 移动站A漫游到被访网络时，向外地代理进行登记，以获得一个临时的转交地址。外地代理要向A的归属代理登记A的转交地址。

   ![](356.png)

   ![](357.png)

3. 归属代理知道移动站A的转交地址后，会构建一条通向转交地址的隧道，将截获的发送给A的IP分组进行再封装，并通过隧道发送给被访网络的外地代理。

   ![](358.png)

4. 外地代理把收到的封装的IP分组进行拆封，恢复成原始的IP分组，然后发送给移动站A，这样A在被访网络就能收到这些发送给它的IP分组。

   ![](359.png)

5. 移动站A在被访网络对外发送IP分组时，仍然使用自己的永久地址作为IP分组的源地址，此时显然无须通过A的归属代理来转发，而是直接通过被访网络的外部代理。

   ![](360.png)

6. 移动站A移动到另一被访网络时，在新外地代理登记后，然后新外地代理将A的新转交地址告诉其归属代理。无论如何移动，A收到的IP分组都是由归属代理转发的。

7. 移动站A回到归属网络时，A向归属代理注销转交地址。

---

为了支持移动性，在网络层中还应增加一些新功能：

- 移动站到外地代理的登记协议；
- 外地代理到归属代理的登记协议；
- 归属代理数据报封装协议；
- 外地代理拆封协议。



所有使用同一外地代理的移动主机都可以共享同一个转交地址。



# IPV6

为了解决“IP地址耗尽”问题，有以下三种措施：

1. 采用无类别编址CIDR，使IP地址的分配更加合理。
2. 采用网络地址转换（NAT）方法以节省全球IP地址。
3. 采用具有更大地址空间的新版本的IPv6。

前两种方法只是延长了IPv4使用寿命，只有第三种方法能从根本上解决IP地址耗尽问题。

## 特点

1. 更大的地址空间

   IPv6将地址从IPv4的32位增大到128位，IPv6的地址空间是IPv4的2^96^倍。

2. 扩展的地址层次结构

   IPv6因为地址空间很大，所以可以划分为更多的层次。

3. 灵活的首部格式

   IPv6定义了许多可选的扩展首部，不仅可提供比IPv4更多的功能，而且能提高路由器的处理效率，这是因为路由器对扩展首部不进行处理。

4. 改进的选项

   IPv6首部长度是固定的，其选项放在有效载荷中，选项是灵活可变的。而IPv4所规定的选项是固定不变的，其选项放在首部的可变部分。

5. 允许协议继续扩充

   IPv6允许不断扩充功能，而IPv4的功能是固定不变的。

6. 支持即插即用（即自动配置）

   因此IPv6不需要使用DHCP。

7. 支持资源的预分配

8. ==IPv6中不充许分片==。IPv6==只有源主机才能分片==，是端到端的，==不允许==类似IPv4传输路径中的==路由分片==。

   因此，若一个路由器收到的IPv6数据报因太大而不能转发到链路上，则丢弃该数据报，并向发送方发送一个指示分组太大的ICMP报文。

9. IPv6首部长度是固定的40B，而IPv4首部长度是可变的（必须是4B的整数倍）。

10. 增大了安全性

![](361.png)

虽然IPv6与IPv4不兼容，但总体而言它与所有其他的互联网协议兼容，包括TCP、UDP、ICMP、IGMP和DNS等，只是在少数地方做了必要的修改（大部分是为了处理长地址）。

## IPV6数据报

![](362.png)

IPv6将IPv4数据报首部中不必要的功能取消了，这使得IPv6数据报基本首部中的字段数量减少到只有8个。但由于IPv6地址的长度扩展到了128比特，因此使得IPv6数据报基本首部的长度反而增大到了40字节，比IPv4数据报首部固定部分的长度（20字节）增大了20字节。

![](363.png)

1. ==版本==

   占**4位**，指明协议的版本，对于IPv6该字段的值是6。

2. ==通信量类==

   占**8位**，用来**区分不同的IPv6数据报的类别或优先级**。

3. ==流标号==

   占2**0位**，IPv6提出流的抽象概念。流是指互联网上从特定源点到特定终点（单播或多播）的**一系列数据报**（如实时音/视频传输），而在这个“流”所经过的路径上的路由器都保证指明的服务质量。所有**属于同一个流的数据报都具有相同的流标号**。

4. ==有效载荷长度==

   占**16位**，指明IPv6数据报**除基本首部以外的字节数**（所有扩展首部都算在有效载荷之内）。这个字段的**最大值是65535字节**。

5. ==下一个首部==

   占**8位**，该字段相当于IPv4首部中的协议字段或可选字段。

   - 当IPv6**没有扩展首部时**，其作用与IPv4的协议字段一样，它指明IPv6数据报所**运载的数据是何种协议数据单元**；

     ![](364.png)

   - 当IPv6**带有扩展首部时**，它就**标识后面第一个扩展首部的类型**。

     ![](365.png)

6. ==跳数限制==

   占**8位**，类似于IPv4首部的TTL字段。

   源点在每个数据报发出时即设定某个限制值（最大为255）。路由器每次转发时将其值减1，减为零时就将该数据报丢弃。

   该字段的作用与IPv4数据报首部中的生存时间TTL字段完全一样。IPv6将名称改为跳数限制后，可使名称与作用更加一致。

7. ==源地址和目的地址==

   占**128位**，是数据报的发送端/接收端的IP地址。

## IPV6地址

### 表示方法

IPv4地址通常使用点分十进制表示法。若IPv6也使用这种表示法，则地址书写起来将相当长。IPv6标准使用冒号十六进制记法，即把地址中的每4位用一个十六进制数表示，并用冒号分隔每16位。

![](366.png)

在IPv6地址的冒号十六进制记法的基础上，再使用==“左侧零”省略==和==“连续零”压缩==，可使IPv6地址的表示更加简洁。

- “左侧零”省略是指两个冒号间的十六进制数中最前面的一串0可以省略不写。
- “连续零”压缩是指一连串连续的0可以用一对冒号取代。

![](367.png)

在==一个IPv6地址中只能使用一次“连续零”压缩==，否则会导致歧义。

![](368.png)

冒号十六进制记法还可**结合点分十进制的后缀**。这在IPv4向IPv6过渡阶段非常有用。

![](369.png)

CIDR的斜线表示法在IPv6中仍然可用。

![](370.png)

### 分类

IPv6数据报的目的地址有以下三种基本类型：

- 单播：就是传统的点对点通信。
- 多播：一点对多点的通信，数据报发送到一组计算机中的每一台。
- 任播：这是IPv6增加的一种类型。任播的终点是一组计算机，但数据报只交付其中的一台计算机，通常是距离最近的一台计算机。

![](371.png)

![](372.png)

1. **未指明地址**：该地址不能用作目的地址，只能用于还未配置IPv6地址的主机作为源地址。

2. **环回地址**：该地址的作用与IPv4的环回地址相同，但IPv6的环回地址仅此一个。

3. **多播地址**：该地址的作用和IPv4的一样。这类地址占IPv6地址空间的1/256。

4. **本地链路单播地址**：该地址的作用类似于IPv4的私有IP地址。

5. **全球单播地址**：用得最多的地址。IPv6全球单播地址采用三级结构：

   - 第一级为全球路由选择前缀，占48位，用于互联网中的路由选择，相当于IPv4分类地址中的网络号；
   - 第二级为子网标识符，占16位，用于各机构构建自己的子网：
   - 第三级为接口标识符，用于指明主机或路由器的单个网络接口，相当于IPv4分类地址中的主机号。

   ![](373.png)

## IPv4向IPv6过渡

从IPv4向IPv6过渡只能**采用逐步演进的办法**，同时还必须使新安装的**IPv6系统能够向后兼容**。IPv6系统必须能够接收和转发IPv4分组，并且能够为IPv4分组选择路由。

从IPv4向IPv6过渡可以采用下列两种策略：

1. **双协议栈**

   指在一台设备上同时装有IPv4和IPv6两个协议栈，分别配置了一个IPv4地址和一个IPv6地址，因此这台设备既能和IPv4网络通信，又能和IPv6网络通信。

   双协议栈主机在与IPv6主机通信时采用IPv6地址，而在与IPv4主机通信时采用IPv4地址，双协议栈主机使用应用层的域名系统（DNS）获知目的主机采用的是哪种地址。

   若DNS返回的是IPv4地址，则双协议的源主机就使用IPv4地址。若DNS返回的是IPv6地址，则双协议栈的源主机就使用IPv6地址。

   ![](374.png)

2. **隧道技术**

   指在IPv6数据报要进入IPv4网络时，把整个IPv6数据报封装成IPv4数据报的数据部分，使原来的IPv6数据报就好像在IPv4网络的隧道中传输。当IPv4数据报离开IPv4网络时，再将其数据部分交给主机的IPv6协议。

   ![](375.png)

