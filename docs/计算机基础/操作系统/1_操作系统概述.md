---
title: 操作系统概述
index: 1
---
## 操作系统的概念

**操作系统**（Operating System，**OS**）是指**控制**和**管理**整个计算机系统的**硬件与软件**资源，合理地组织、调度计算机的工作与资源的分配，进而**为用户和其他软件提供方便接口与环境**的程序集合。操作系统是计算机系统中**最基本的系统软件**。

![](../../../images/计算机/操作系统/1.png)

## 操作系统的特征

![](../../../images/计算机/操作系统/12.png)

### 并发

**并发**：指两个或多个事件在**同一时间间隔**内发生。这些事件宏观上是同时发生的，微观上是交替发生的。

**操作系统的并发性**：指计算机系统中同时存在多个运行的程序，这些程序宏观上看是同时发生的，微观上看是交替发生的。

::: info 同一时间间隔（并发）和同一时刻（并行）的区别

![](../../../images/计算机/操作系统/8.png)

:::

::: tip

单核 CPU 同一时刻只能执行一个程序，各个程序只能并发执行；

多核 CPU 同一时刻可以执行多个程序，多个程序可以并行执行（运行程序数量要小于核的数量）；

:::

### 共享

共享即资源共享，是指系统中的资源可供内存中多个并发执行的进程共同使用。

![](../../../images/计算机/操作系统/9.png)

共享和并发的关系：

1. 资源共享是以程序的并发为条件的，若系统不允许程序并发执行，则不存在资源共享问题；
2. 若系统不能对资源共享实施有效的管理，则必将影响到程序的并发执行，甚至根本无法并发执行。

![](../../../images/计算机/操作系统/10.png)

### 虚拟

虚拟：指把一个物理上的实体变为若干逻辑上的对应物。前者是实际存在的；而后者是用户感觉上的事物。

用于实现虚拟的技术，称为虚拟技术。

::: info

操作系统中利用了多种虚拟技术来实现虚拟处理器、虚拟内存和虚拟外部设备等。

:::

- 虚拟处理器

  利用多道程序设计技术把一个物理上的 CPU 虚拟为多个逻辑上的 CP。

- 虚拟存储器

  采用虚拟存储器技术将一台机器的物理存储器变为虚拟存储器，从逻辑上扩充存储器的容量，此时用户感觉到的存储器（实际不存在）称为虚拟存储器。

![](../../../images/计算机/操作系统/11.png)

### 异步

多道程序环境允许多个程序并发执行，但由于资源有限，进程的执行并不是一贯到底的，而是走走停停的，它以不可预知的速度向前推进，这就是进程的异步性。

异步性使得操作系统运行在一种随机的环境下，可能导致进程产生与时间有关的错误（就像对全局变量的访问顺序不当会导致程序出错一样）。但只要运行环境相同，操作系统就须保证多次运行进程后都能获得相同的结果。

::: tip

只有系统拥有并发性，才有可能导致异步性。

:::

## 操作系统的目标和功能

### 计算机系统资源的管理者

![](../../../images/计算机/操作系统/2.png)

1. 处理机管理

   在多道程序环境下，处理机的分配和运行都以进程（或线程）为基本单位，因而对处理机的管理可归结为对进程的管理。

2. 存储器管理

   存储器管理是为了给多道程序的运行提供良好的环境，方便用户使用及提高内存的利用率。

3. 文件管理

   计算机中的信息都是以文件的形式存在的，操作系统中负责文件管理的部分称为**文件系统**。

4. 设备管理

   设备管理的主要任务是完成用户的 I/O 请求，方便用户使用各种设备，并提高设备的利用率。

---

### 用户与计算机硬件系统之间的接口

![](../../../images/计算机/操作系统/6.png)

操作系统提供的接口主要分为两类：

1. **命令接口**

   用户利用这些操作命令来组织和控制作业的执行。

   - **联机命令接口**（交互式命令接口）

     ![](../../../images/计算机/操作系统/3.png)

   - 脱机命令接口（批处理命令接口）

     ![](../../../images/计算机/操作系统/4.png)

2. **程序接口**

   用户通过在程序中进行**系统调用**来使用程序接口。普通用户不能直接使用程序接口，只能通过代码**间接**使用。

   ![](../../../images/计算机/操作系统/5.png)

---

### 对计算机资源的扩充

![](../../../images/计算机/操作系统/7.png)

## 操作系统发展历程

![](../../../images/计算机/操作系统/18.png)

### 手工操作阶段

此阶段无操作系统。

缺点：

1. **用户独占全机**，虽然不会出现因资源已被其他用户占用而等待的现象，但资源利用率低。
2. CPU 等待手工操作，**CPU 的利用不充分**。

![](../../../images/计算机/操作系统/13.png)

### 批处理阶段

操作系统开始出现。

> 为了解决人机矛盾及 CPU 和 I/O 设备之间速度不匹配的矛盾。

#### 单道批处理系统

系统对作业的处理是成批进行的，但内存中始终保持一道作业。

![](../../../images/计算机/操作系统/14.png)

主要特征：

1. 自动性

   在顺利的情况下，磁带上的一批作业能自动地逐个运行，而无须人工干预。

2. 顺序性

   磁带上的各道作业顺序地进入内存，各道作业的完成顺序与它们进入内存的顺序在正常情况下应完全相同，亦即先调入内存的作业先完成。

3. 单道性

   内存中仅有一道程序运行，即监督程序每次从磁带上只调入一道程序进入内存运行，当该程序完成或发生异常情况时，才换入其后继程序进入内存运行。

![](../../../images/计算机/操作系统/15.png)

#### 多道批处理系统

多道程序设计技术允许多个程序同时进入内存并允许它们在 CPU 中交替地运行，这些程序共享系统中的各种硬/软件资源。当一道程序因 I/O 请求而暂停运行时，CPU 便立即转去运行另一道程序。

主要特征：

1. 多道

   计算机内存中同时存放多道相互独立的程序。

2. 宏观上并行

同时进入系统的多道程序都处于运行过程中，即它们先后开始各自的运行, 但都未运行完毕。

3. 微观上串行

   内存中的多道程序轮流占有 CPU，交替执行。

![](../../../images/计算机/操作系统/16.png)

### 分时操作系统

分时技术：把处理器的运行时间分成很短的时间片，按时间片轮流把处理器分配给各联机作业使用。若某个作业在分配给它的时间片内不能完成其计算，则该作业暂时停止运行，把处理器让给其他作业使用，等待下一轮再继续运行。

分时操作系统：多个用户通过终端同时共享一台主机，这些终端连接在主机上，用户可以同时与主机进行交互操作而互不干扰。

主要特征：

1. 同时性

   同时性也称多路性，指允许多个终端用户同时使用一台计算机。

2. 交互性

   用户能够方便地与系统进行人机交互。

3. 独立性

   系统中多个用户可以彼此独立地进行操作，互不干扰。

4. 及时性

   用户请求能在很短时间内获得响应。

优点：用户请求可以被即使响应，**解决了人机交互问题**。允许多个用户同时使用一台计算机，并且用户对计算机的操作相互独立。

缺点：**不能优先处理一些紧急任务**。操作系统对各个用户/作业都是完全公平的，循环地为每个用户/作业时间片，不区分任务的紧急性。

### 实时操作系统

> 为了能在某个时间限制内完成某些紧急任务而不需要时间片排队

实时操作系统可以分为：

1. 硬实时系统

   某个动作必须绝对地在规定的时刻（或规定的时间范围）发生，如导弹控制系统。

2. 软实时系统

   能够接受偶尔违反时间规定且不会引起任何永久性的损害，如订票系统。

在实时操作系统的控制下，计算机系统接收到外部信号后及时进行处理，并**在严格的时限内处理完接收的事件**。

实时操作系统的主要特点是**及时性**和**可靠性**。

### 网络操作系统、分布式计算机系统、个人计算机操作系统

![](../../../images/计算机/操作系统/17.png)

## 操作系统运行环境

### 操作系统运行机制

![](../../../images/计算机/操作系统/21.png)

在计算机系统中，通常 CPU 执行两种不同性质的程序：

- **内核程序**：操作系统中的一个核心组件，它是操作系统的主要部分之一，负责管理计算机的硬件资源和提供对这些资源的访问。
- **应用程序**：一种计算机程序，旨在执行特定的任务、功能或目的，以满足用户的需求。应用程序通常运行在操作系统之上，利用操作系统提供的服务和资源来完成各种任务。

::: info

**操作系统内核**（内核）是由很多内核程序组成的。内核是操作系统最重要最核心的部分，也是最接近硬件的部分。

操作系统的功能未必都在内核中，如图形化用户界面 GUI。

:::

1. 特权指令：不允许用户直接使用的指令，如 I/O 指令、置中断指令，存取用于内存保护的寄存器、送程序状态字到程序状态字寄存器等的指令。
2. 非特权指令：允许用户直接使用的指令，为了防止用户程序对系统造成破坏，它不能直接访问系统中的软硬件资源，仅限于访问用户的地址空间。

![](../../../images/计算机/操作系统/19.png)

CPU 如何分辨出当前是应用程序还是内核程序？

将 CPU 的运行模式划分为**用户态**（目态）和**核心态**（又称管态、内核态）。应用程序运行在用户态，操作系统内核程序运行在核心态。

- 处于核心态时，说明此时运行的是内核程序，此时可以执行特权指令；
- 处于用户态时，说明此时运行的是应用程序，此时只能执行非特权指令；

::: tip 拓展

CPU 内部有一个程序状态字寄存器（PSW），其中有个二进制位，1 表示核心态，0 表示用户态。

:::

![](../../../images/计算机/操作系统/20.png)

内核是计算机上配置的底层软件，它管理着系统的各种资源，可以看作是连接应用程序和硬件的一座桥梁，大多数操作系统的内核包含一下 4 方面的内容：

1. **时钟管理**

   在计算机的各种部件中，时钟是最关键的设备。通过时钟管理，向用户提供标准的系统时间。通过时钟中断的管理，可以实现进程的切换。

2. **中断机制**

   操作系统各项操作的基础，如进程的管理和调度、系统功能的调用、设备驱动、文件访问等。

3. **原语**

   按层次结构设计的操作系统，底层必然是一些可被调用的公用小程序，它们各自完成一个规定的操作。

   特点：

   - 处于操作系统的最底层，是最接近硬件的部分。
   - 运行具有原子性，出于系统安全性和便于管理考虑其操作只能一气呵成。
   - 运行时间都较短，而且调用频繁。

   具有这些特点的程序称为原语。

4. **系统技制的数据结构及处理**

   系统中用来登记状态信息的数据结构很多，如消息队列、缓冲区、内存分配表等。

   为了实现有效的管理，系统需要一些基本的操作，常见的操作有以下 3 种：

   - 进程管理：进程状态管理、进程调度和分派、创建与撤销进程控制块等。
   - 存储器管理：存储器的空间分配和回收、内存信息保护程序、代码对换程序等。
   - 设备管理：缓冲区管理、设备分配和回收等。

::: tip

核心态指令实际上包括系统调用类指令和一些针对时钟、中断和原语的操作指令。

:::

### 中断和异常的概念

操作系统是中断驱动的，OS 总在等待某个事件的发生，事件总是由中断或异常引起的。

![](../../../images/计算机/操作系统/24.png)

**定义**

- **中断**：由**硬件**引起。

  也称**外中断**，是指来自 CPU 执行指令外部的事件，通常用于信息输入/ 输出。如设备发出的 I/O 结束中断，表示设备输入/输出处理已经完成。

- **异常**：由**软件**引起。

  也称**内中断**，是指来自 CPU 执行指令内部的事件。如程序的非法操作码、地址越界、运算溢出等引起的事件。

**分类**

![](../../../images/计算机/操作系统/22.png)

**处理过程**

![](../../../images/计算机/操作系统/23.png)

若中断或异常处理程序能够解决相应的问题，则在中断或异常处理程序的最后，CPU 通过执行中断或异常返回指令，回到被打断的用户程序的第 i 条指令或 第 i+1 条指令继续执行；

若中断或异常处理程序发现是不可恢复的致命错误，则终止用户程序。

### 系统调用

![](../../../images/计算机/操作系统/28.png)

系统调用：用户在程序中调用操作系统所提供的一些子功能，系统调用可视为特殊的公共子程序。

::: tip 系统调用和库函数的区别

![](../../../images/计算机/操作系统/25.png)

:::

> 在用户程序中，凡是与资源有关的操作（如存储分配、进行 I/O 传输及管理文件等），都必须通过系统调用方式向操作系统提出服务请求，并由操作系统代为完成。

系统调用按功能大致可分为如下几类：

- 设备管理：完成设备的请求或释放，以及设备启动等功能；
- 文件管理：完成文件的读、写、创建及删除等功能；
- 进程控制：完成进程的创建、撤销、阻塞及唤醒等功能；
- 进程通信：完成进程之间的消息传递或信号传递等功能；
- 内存管理：完成内存的分配、回收以及获取作业占用内存区大小及始址等功能；

**系统调用执行过程**

系统调用的处理需要由操作系统内核程序负责完成，要运行在核心态。

用户程序可以执行**陷入指令**来发起系统调用，请求操作系统提供服务。

> 用户程序执行“陷入指令”，相当于把 CPU 的使用权主动交给操作系统内核程序（CPU 状态会从用户态进入核心态），之后操作系统内核程序再对系统调用请求做出相应处理。处理完成后，操作系统内核程序又会把 CPU 的使用权还给用户程序（即 CPU 状态会从核心态回到用户态）。

这样设计的目的是：保证系统的稳定性和安全性，防止用户程序随意更改或访问重要的系统资源，影响其他进程的运行。

![](../../../images/计算机/操作系统/26.png)

![](../../../images/计算机/操作系统/27.png)

::: info 用户态转向核心态的例子：

1. 用户程序要求操作系统的服务，即系统调用；
2. 发生一次中断；
3. 用户程序中产生了一个错误状态；
4. 用户程序中企图执行一条特权指令；
5. 从核心态转向用户态由一条指令实现，这条指令也是特权命令，一般是中断返回指令；

:::

::: tip

由用户态进入核心态，不仅状态需要切换，而且所用的堆栈也可能需要由用户堆栈切换为系统堆栈、但这个系统堆栈也是属于该进程的。

:::

## 操作系统结构

![](../../../images/计算机/操作系统/37.png)

### 分层法

分层法是将操作系统分为若干层，在低层上构建高层。最底层（层 0）为硬件，最高层（层 N）为用户接口。高层仅依赖于紧邻它的底层。

![](../../../images/计算机/操作系统/30.png)

优点：

1. 易保证系统的准确性。
2. 易扩充和易维护。

缺点：

1. 合理定义各层比较困难。
2. 效率较差。

### 模块化

模块化是将操作系统按功能划分为若干具有一定独立性的模块。每个模块具有某方面的管理功能，并规定好各模块间的接口，使各模块之间能够通过接口进行通信。还可以进一步将各模块细分为若干具有一定功能的子模块，同样也规定好各子模块之间的接口。

![](../../../images/计算机/操作系统/31.png)

划分模块时，

1. 模块不能划分得太小，也不能划分得过大。

2. 要充分考虑模块的独立性问题。

   衡量模块的独立性主要有两个标准：

   - 内聚性：模块内部各部分间联系的紧密程度。内聚性越高，模块独立性越好；
   - 耦合度：模块间相互联系和相互影响的程度。耦合度越低，模块独立性越好；

优点：

1. 提高了操作系统设计的正确性、可理解性和可维护性；
2. 增强了操作系统的可适应性；
3. 加速了操作系统的开发过程；

缺点：

1. 模块间的接口规定很难满足对接口的实际需求；
2. 各模块设计者齐头并进, 每个决定无法建立在上一个己验证的正确决定的基础上，因此无法找到一个可靠的决定顺序。

### 内核

内核是操作系统最基本、最核心的部分。实现操作系统内核功能的程序就是内核程序。

![](../../../images/计算机/操作系统/29.png)

![](../../../images/计算机/操作系统/33.png)

由上图可以引出内核的两种设计方法

1. 把所有功能都包含在操作系统内核中的就叫宏内核；
2. 只保留与硬件关系最紧密的部分就叫微内核；

换句话说，从操作系统的内核架构来划分，可分为**宏内核**和**微内核**。

#### 宏内核

宏内核，也称**单内核**或**大内核**，是指将系统的主要功能模块都作为一个紧密联系的整体运行在核心态，从而为用户程序提供高性能的系统服务。

#### 微内核

微内核构架，是指将内核中最基本的功能保留在内核，而将那些不需要在核心态执行的功能移到用户态执行，从而降低内核的设计复杂性。

在进行操作系统结构设计时，大多采用**基于客户/服务器模式**的微内核结构，将操作系统划分为两大部分：**微内核**和**多个服务器**。

微内核基本概念：

1. 足够小的内核

   内核是指精心设计的、能实现操作系统最基本核心功能的小型内核。

   微内核不是一个完整的 OS，而只是将操作系统中最基本的部分放入微内核，通常包含：

   1. 与硬件处理紧密相关的部分；
   2. 一些较基本的功能；
   3. 客户和服务器之间的通信；

   ***

2. 基于客户/服务器模式

   客户与服务器之间是借助微内核提供的消息传递机制来实现信息交互的。

   ![](../../../images/计算机/操作系统/35.png)

   ***

3. 应用“机制与策略分离”原理

   机制：实现某一功能的具体执行结构；

   策略：在进制的基础上借助于某些参数和算法来实现功能的优化，或达到不同的功能目标；

4. ***

   采用面向对象技术

<br>

在微内核结构中，为了实现高可靠性，只有微内核运行在内核态，其余模块都运行在用户态， 一个模块中的错误只会使这个模块崩溃，而不会使整个系统崩溃。

> 例如，文件服务代码运行时出了问题，
>
> - 宏内核的文件服务是运行在内核态的，系统会直接崩溃。
> - 微内核的文件服务是运行在用户态的，只要把文件服务功能强行停止，然后重启，就可以继续使用，系统不会崩溃。

<br>

微内核的基本功能：

1. 进程（线程）管理；
2. 低级存储器管理；
3. 中断和陷入处理；

<br>

微内核系统优点：

1. 提高了系统的可扩展性
2. 增强了系统的可靠性
3. 可移植性强
4. 提供了对分布式系统的支持
5. 融入了面向对象技术

微内核结构的主要问题是性能问题，因为要频繁地在核心态和用户态之间进行切换。

#### 宏内核和微内核比较

![](../../../images/计算机/操作系统/32.png)

![](../../../images/计算机/操作系统/34.png)

### 外核

在底层中，一种称为外核（exokemel）的程序在内核态中运行。它的任务是为虚拟机分配资源，并检查使用这些资源的企图，以确保没有机器会使用他人的资源。每个用户层的虚拟机可以运行自己的操作系统，但限制只能使用已经申请并且获得分配的那部分资源。

![](../../../images/计算机/操作系统/36.png)

优点：

- 减少了映射层。在其他的设计中，每个虚拟机都认为它有自己的磁盘，虚拟机监控程序就必须维护一张表格以重映像磁盘地址，有了外核，这个重映射处理就不需要了。
- 将多道程序（在外核内）与用户操作系统代码（在用户空间内）加以分离，而且相应的负载并不重。

## 操作系统引导

操作系统引导是指计算机利用 CPU 运行特定程序，通过程序识别硬盘，识别硬盘分区，识别硬盘分区上的操作系统，最后通过程序启动操作系统。

![](../../../images/计算机/操作系统/38.png)

常见操作系统的引导过程如下：

1. 激活 CPU；
2. 硬件自检；
3. 加载带有操作系统的硬盘；
4. 加载主引导记录 MBR；
5. 扫描硬盘分区表，并加载硬盘活动分区；
6. 加载分区引导记录 PBR；
7. 加载启动管理器；
8. 加载操作系统；

## 虚拟机

::: info 传统计算机

![](../../../images/计算机/操作系统/39.png)

:::

虚拟机：使用虚拟化技术，将一台物理机虚拟化为多台虚拟机器（Virtual Machine，VM），每个虚拟机器都可以独立运行一个操作系统。

### 第一类虚拟机管理程序

![](../../../images/计算机/操作系统/40.png)

从技术上讲，第一类虚拟机管理程序就像一个操作系统，因为它是唯一一个运行在最高特权级的程序。

虚拟机作为用户态的一个进程运行，不允许执行特权指令。

虚拟机上的操作系统认为自己运行在内核态（实际上不是），称为虚拟内核态。

当虚拟机操作系统执行了一条特权指令时，

- 在支持虚拟化的 CPU 上

  虚拟机管理程序会检查这条指令是由虚拟机中的操作系统执行的还是由用户程序执行的。如果是前者，虚拟机管理程序将安排这条指令功能的正确执行。否则，虚拟机管理程序将模拟真实硬件面对用户态执行特权指令时的行为。

- 在不支持虚拟化的 CPU 上

  真实硬件不会直接执行虚拟机中的敏感指令，这些敏感指令被转为对虚拟机管理程序的调用，由虚拟机管理程序模拟这些指令的功能。

### 第二类虚拟机管理程序

![](../../../images/计算机/操作系统/41.png)

它是一个依赖于操作系统分配和调度资源的程序，很像一个普通的进程。

### 两类虚拟机管理程序的对比

![](../../../images/计算机/操作系统/42.png)
