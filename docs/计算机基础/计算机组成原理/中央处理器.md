---
title: 中央处理器
index: 5
typora-root-url: ./..\..\..\..\IMG\docs\计算机\计算机组成原理
---

# CPU

## 功能

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/296.png)

CPU的具体功能包括：

1. **指令控制**：完成取指令（也称取指）、分析指令和执行指令的操作，即程序的顺序控制。
2. **操作控制**：产生完成一条指令所需的操作信号，把各种操作信号送到相应的部件，从而控制这些部件按指令的要求正确执行。
3. **时间控制**：严格控制各种操作信号的出现时间、持续时间及出现的时间顺序。
4. **数据加工**：对数据进行算术和逻辑运算。
5. **中断处理**：对运行过程中出现的异常情况和中断请求进行处理。

## 基本结构

### 运算器

运算器主要功能是**根据控制器送来的命令，对数据执行算术运算**（加、减、乘、除）、**逻辑运算**（与、或、非、异或、移位、求补等）或**条件测试**（用于设置ZF、SF、OF和CF等标志位，作为条件转移的判断条件）。

运算器主要由以下部分组成：

1. **算术逻辑单元(ALU)**

2. **暂存寄存器**

   用于暂存从数据总线或通用寄存器送来的操作数，以便在取出下一个操作数时将其同时送入ALU。暂存寄存器 **==对应用程序员是透明的==**（不可见）。

3. **累加寄存器(ACC)**

   一个通用寄存器，用于暂时**存放ALU运算的结果**。

4. **通用寄存器组(GPRs)**

   用于存放**操作数**（包括源操作数、目的操作数及中间结果）和**各种地址信息**等，如AX、BX、CX、DX、SP等。其**位数与机器字长相等**，因此便于操作控制。在指令中要指定寄存器的编号，才能明确是对哪个寄存器进行访问。SP是堆栈指针，用于指示栈顶的地址。

5. **程序状态字寄存器(PSW)**

   **每个标志位通常由一位触发器来保存，这些标志位组合在一起称为程序状态字**。程序状态字的各位表征程序和机器的运行状态。

   **==程序状态字寄存器对用户不透明==**。

   由**算术/逻辑运算指令**或**测试指令**的运行结果而建立的各种状态信息，

   - 一种是状态标志，如溢出标志(OF)、符号标志(SF)、零标志(ZF)、进位标志(CF)等；
   - 另一种是控制标志，如中断标志、陷阱标志等。

6. **移位寄存器(SR)**

   不但**可用来存放操作数**，而且在控制信号的作用下，寄存器中的数据可根据需要向左或向右移位。

7. **计数器(CT)**：控制乘除运算的操作步数。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/297.png)

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/298.png)

### 控制器

控制器的全部功能是**取指令、分析指令和执行指令**，执行指令就是发出有关操作控制信号。

控制器的主要功能是执行指令，每条指令的执行是由控制器发出的一组微操作实现的。

控制器的工作原理是，根据指令操作码、指令的执行步骤（微命令序列）和条件信号来形成当前计算机各部件要用到的控制信号。计算机整机各硬件系统在这些控制信号的控制下协同运行，产生预期的执行结果。控制器是整个系统的指挥中枢，在控制器的控制下，运算器、存储器和输入/输出设备等功能部件构成一个有机的整体，根据指令的要求指挥全机协调工作。

控制器主要由以下部分组成：

1. **程序计数器(PC, Program Counter)**：用于指出**欲执行指令在主存储器中的存放地址**。若PC和主存储器均按字节编址，则PC的位数等于主存储器地址位数。CPU根据PC的内容从主存储器中取指令，然后送入指令寄存器。指令通常是顺序执行的，因此PC具有自动加1的功能（这里的“1”是指一条指令的字节数）；当遇到转移类指令时，PC的新值由指令计算得到。
2. **指令寄存器(IR, Instruction register)**：用于**保存当前正在执行的指令**，IR的位数等于指令字长。
3. **指令译码器(ID, Instruction Decoder)**
4. **存储器地址寄存器(MAR)**：用于存放要访问的主存储器单元的地址，MAR的位数等于主存储器地址线数，它反映了最多可寻址的存储单元的个数。
5. **存储器数据寄存器(MDR)**：用于存放向主存储器写入的信息或从主存储器读出的信息，MDR的位数等于存储字长。当CPU和主存储器交换信息时，都要用到MAR和MDR。
6. **微操作信号发生器(CU, Control Unit)**：产生微操作命令序列
7. **时序电路**

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/299.png)

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/300.png)

# 指令执行过程

## 指令周期

**==指令周期==**：**==CPU每取出并执行一条指令所需的全部时间**，**不同指令的指令周期可能不同==**。

机器周期是指令执行中每步操作（如取指令、存储器读、存储器写等）所需要的时间，每个**机器周期的长度可变**。指令周期通常可用若干 **==机器周期==** 来表示，**机器周期又叫CPU周期**。

一个机器周期又包含若干==时钟周期==（也称为节拍、T周期或CPU时钟周期，它是**CPU操作的最基本单位**，每个指令周期一定大于或等于一个CPU时钟周期）。

::: info

总线周期：一次总线操作所需的时间，通常为一个或多个时钟周期。

存取周期：存储器进行一次读或写操作所需的时间称为存储器的读/写时间，而连续启动两次独立的读或写操作（如连续两次读操作）所需的最短时间称为存取周期。机器周期通常由存取周期确定。

:::

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/301.png)

每个指令周期内的机器周期数可以不等，每个机器周期内的节拍数也可以不等。

- 对于无条件转移指令`JIMP X`，在执行时不需要访问主存，只包含取指阶段（包括取指和分析）和执行阶段，所以其指令周期仅包含取指周期和执行周期。
- 对于间接寻址的指令，为了取操作数，需要先访问一次主存，取出有效地址，然后访问主存，取出操作数，所以还需包括间址周期。间址周期介于取指周期和执行周期之间。
- 当CPU采用中断方式实现主机和I/O设备的信息交换时，CPU在每条指令执行结束前，都要发中断查询信号，若有中断请求，则CPU进入中断响应阶段，也称中断周期。

> 指令字长一般都取存储字长的整数倍，若指令字长等于存储字长的2倍，则需要两次访存，取指周期等于机器周期的2倍；若指令字长等于存储字长，则取指周期等于机器周期。

这样，一个完整的指令周期可包括**取指、间址、执行和中断**4个周期。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/302.png)

1. 当CPU执行指令时，首先进入取指周期，从PC指出的主存单元中取出指令，送至指令寄存器，同时PC加“1”以作为下一条指令的地址。当遇到转移指令等改变执行顺序的指令时，在PC加“1”后会重新计算并更新PC值。
2. 然后判断是否有间接寻址，如果有，那么进入间址周期以获取操作数的有效地址。
3. 之后进入执行周期，完成取操作数、执行运算和存操作数的任务。
4. 执行周期结束后，如果CPU检测到中断请求，则进入中断周期，此时需要关中断、保存断点、修改PC值为中断服务程序的入口地址，并转向中断服务程序。

## 指令周期的数据流

### 取值周期

取指周期的任务是**根据PC中的内容从主存中取出指令代码并存放在IR中**。

取指操作是自动进行的，控制器不需要得到相应的指令。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/304.png)

**不同长度的指令，其取指操作可能是不同的**。例如，双字指令、三字指令与单字指令的取指操作是不同的。

### 间址周期

间址周期的任务是**取操作数有效地址**。将指令中的地址码送到MAR并送至地址总线，此后CU向存储器发出读命令，以获取有效地址并存至MDR。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/305.png)

::: tip

Ad(IR) 表示取出IR中存放的指令字的地址字段。

:::

### 执行周期

执行周期的任务是取操作数，并根据IR中的指令字的操作码通过ALU操作产生执行结果。

不同指令的执行周期操作不同，因此**没有统一的数据流向**。

### 中断周期

中断周期的任务是处理中断请求。

假设程序断点存入堆栈中，并用SP指示栈顶地址，而且进栈操作是先修改栈顶指针，后存入数据。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/306.png)

::: tip

中断周期中的进栈操作是将SP减“1”。这和传统意义上的进栈操作相反，原因是计算机中的堆栈都是向低地址方向增长，所以进栈操作是减“1”而不是加“1”。

:::

##  指令执行方案

1. **单周期处理器**

   单周期处理器对所有指令都选用相同的执行时间来完成。

   此时每条指令都在一个时钟周期内完成（即**CPI=1**），指令之间**串行执行**，即下一条指令只能在前一条指令执行结束后才能启动。因此，**指令周期取决于执行时间最长的指令的执行时间**。

   对于那些本来可以在更短时间内完成的指令，仍要使用这个较长的周期来完成，会降低整个系统的运行速度。

2. **多周期处理器**

   多周期处理器对不同类型的指令选用不同的执行步骤。

   指令需要几个周期就为其分配几个周期，因此可选用不同个数的时钟周期来完成不同指令的执行过程（即**CPI>1**），不再要求所有指令占用相同的执行时间。

   多指令周期方案中指令之间仍是**串行执行**。

3. **流水线处理器**

   流水线处理器采用指令之间并行执行的方案，其追求的目标是力争在每个时钟周期完成一条指令的执行过程（只在理想情况下才能达到该效果，此时CPI=1）。

   这种方案通过在每个时钟周期启动一条指令，尽量让多条指令同时运行，但各自处在不同的执行步骤中。

::: tip

单周期CPU执行任何指令的时间不一定都会小于多周期CPU，这取决于单周期CPU和多周期CPU的时钟周期的长短，以及该指令在多周期CPU下所需的时钟周期数。

:::

# 数据通路

## 功能

不论CPU的内部结构多么复杂，它都可视为由**数据通路**(Data Path)和**控制部件**(Control Unit)两大部分组成。

**数据通路**：数据在指令执行过程中所经过的路径，包括路径上的部件。ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等都是指令执行时数据流经的部件，都属于数据通路的一部分。

数据通路描述了信息从哪里开始，中间经过哪些部件，最后被传送到哪里。数据通路**由控制部件控制**，控制部件根据每条指令功能的不同，生成对数据通路的控制信号。

## 组成

组成数据通路的元件主要分为**组合逻辑元件**和**时序逻辑元件**两类。

### 组合逻辑元件（操作元件）

任何时刻产生的输出仅取决于当前的输入。

组合电路不含存储信号的记忆单元，也不受时钟信号的控制，输出与输入之间无反馈通路，信号是单向传输的。

数据通路中常用的组合逻辑元件有加法器、算术逻辑单元（ALU）、译码器、多路选择器、三态门等。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/307.png)

### 时序逻辑元件（状态元件）

任何时刻的输出不仅与该时刻的输入有关，还与该时刻以前的输入有关，因而时序电路必然包含存储信号的记忆单元。

此外，时序电路必须在时钟节拍下工作。各类寄存器和存储器，如通用寄存器组、程序计数器、状态/移位/暂存/锁存寄存器等，都属于时序逻辑元件。

## 基本结构

数据通路结构直接影响CPU内各种信息的传送路径，数据通路不同，指令执行过程的微操作序列的安排也不同，它关系着微操作信号形成部件的设计。

### CPU内部单总线方式

> [https://www.bilibili.com/video/BV1ps4y1d73V](https://www.bilibili.com/video/BV1ps4y1d73V?t=222.8&p=64)

将ALU及所有寄存器都连接到一条内部公共总线上，称为单总线结构的数据通路。

这种结构比较简单，但数据传输存在较多的冲突现象，性能较低。

::: tip

此总线在CPU内部，注意不要把它与连接CPU、存储器和外设的系统总线相混淆。

- 内部总线是指同一部件，如CPU内部连接各寄存器及运算部件之间的总线。
- 系统总线是指同一台计算机系统的各部件，如CPU、内存、通道和各类V/O接口间互相连接的总线。

:::

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/312.png)

> 上图中
>
> - GPRs为通用寄存器组，rs、rd分别为所读、写的通用寄存器的编号；
>
> - Y和Z为暂存器；
>
> - FR为标志寄存器，用于存放ALU产生的标志信息。
>
> - 带箭头的虚线表示控制信号，字母加“in”表示该部件允许写入，字母加“out”表示该部件允许输出。
>
>   MDRin表示内部总线上信息写入MDR，MDRout表示MDR的内容送入内部总线。
>
>   能输出到总线的部件均通过一个三态门与内部总线相连，用于控制该部件与内部总线之间数据通路的连接与断开。

![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/308.png)

> 例题
>
> ![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/309.png)
>
> ![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/310.png)
>
> ![](https://cdn.jsdelivr.net/gh/kisssssssss/IMG/docs/计算机/计算机组成原理/311.png)

### CPU内部多总线方式

CPU内部有两条或更多的总线时，构成双总线结构或多总线结构。将所有寄存器的输入端和输出端都连接到多条公共通路上，相比之下单总线中一个时钟内只允许传送一个数据，因而指令执行效率很低，因此采用多总线方式，同时在多个总线上传送不同的数据，提高效率。

### 专用数据通路方式

根据指令执行过程中的数据和地址的流动方向安排连接电路，避免使用共享的总线，性能较高，但硬件量大。

![](/313.png)

# 控制器

![](314.png)

> - FE: fetch
> - IND: In Direct
> - EX: executive
> - INT: intrrupt

## 结构

![](315.png)

1. 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据。
2. 输入设备和输出设备通过接口电路与总线相连接。
3. 内存储器、输入设备和输出设备从地址总线接收地址信息，从控制总线得到控制信号，通过数据总线与其他部件传送数据。
4. 控制器部件从数据总线接收指令信息，从运算器部件接收指令转移地址，送出指令地址到地址总线，还要向系统中的部件提供它们运行所需要的控制信号。

## 功能

控制器是计算机系统的指挥中心，控制器的主要功能有：

1. 从主存中取出一条指令，并指出下一条指令在主存中的位置。
2. 对指令进行译码或测试，产生相应的操作控制信号，以便启动规定的动作。
3. 指挥并控制CPU、主存、输入设备和输出设备之间的数据流动方向。



根据控制器产生微操作控制信号的方式的不同，控制器可分为硬布线控制器和微程序控制器，两类控制器中的PC和IR是相同的，但确定和表示指令执行步骤的办法及给出控制各部件运行所需要的控制信号的方案是不同的。

## 硬布线控制器

硬布线控制器由复杂的组合逻辑门电路和触发器构成，也称组合逻辑控制器，其原理是根据指令的要求、当前的时序及内外部的状态，按时间的顺序发送一系列微操作控制信号。

指令的操作码是决定控制单元 (CU) 发出不同控制信号的关键。为了简化CU的逻辑，将存放在IR的n位操作码经过译码电路产生2^n^个输出，每种操作码对应一个输出送至CU。

如果将指令译码器和节拍发生器从CU中分离出来，便可得到如图所示的简化的控制单元框图。

![](316.png)

控制单元（CU）的输入信号来源如下：

1. 经指令译码器译码产生的指令信息

   现行指令的操作码决定了不同指令在执行周期所需完成的不同操作，它与时钟配合产生不同的控制信号。

2. 时序系统产生的机器周期信号和节拍信号

   为了使控制单元按一定的先后顺序、一定的节奏发出各个控制信号，控制单元必须受时钟控制。

3. 来自执行单元的反馈信息即标志

   控制单元有时需依赖CPU当前所处的状态产生控制信号，如BAN指令，控制单元要根据上条指令的结果是否为负来产生不同的控制信号。

![](318.png)

### 设计

![](322.png)

#### 分析每个阶段的微操作序列

![](317.png)

#### 安排微操作时序

##### 取址周期

![](319.png)

##### 间址周期

![](320.png)

##### 执行周期

![](321.png)

#### 电路设计

![](323.png)

##### 列出操作时间表

![](324.png)

![](325.png)

![](326.png)

##### 写出微操作命令的最简表达式

![](327.png)

##### 画出逻辑图

![](328.png)

### 特点

硬布线控制的功能由逻辑门组合实现，其速度主要取决于电路延迟，因此高速计算机中的关键核心部件CPU往往采用硬布线逻辑实现。因此，RISC一般都选用硬布线控制器。

指令越多，修改、设计、扩充和实现就越困难。

指令系统功能越全，微操作命令就越多，电路也就越庞杂，调试就更困难。

## 微程序控制器

![](341.png)

### 基本概念

微程序的设计思想就是将每条机器指令编写成一个微程序，每个微程序包含若干微指令，每条微指令对应一个或几个微操作命令。

因此，执行一条指令的过程就是执行一个微程序的过程，这些微程序存储在一个控制存储器中。

目前，大多数计算机都采用微程序设计技术。

![](329.png)

---

**微指令**是若干微命令的集合，一条微指令通常至少包含两大部分信息：

1. 操作控制字段，也称微操作码字段，用于产生某一步操作所需的各种操作控制信号。
2. 顺序控制字段，也称微地址码字段，用于控制产生下一条要执行的微指令地址。

**微周期**是指从控制存储器中取出并执行一条微指令所需的全部时间，通常为一个时钟周期。

---

**微命令**：在微程序控制的计算机中，控制部件向执行部件发出的各种控制命令称为微命令，它是构成控制序列的最小单位。例如，打开或关闭某个控制门的电位信号、某个寄存器的打入脉冲等。执行部件收到微命令后所进行的操作称为微操作，微命令和微操作是一一对应的。

微命令有相容性和互斥性之分：

- 相容性微命令：指那些可以同时出现、共同完成某一些微操作的微命令；
- 互斥性微命令：指在机器中不允许同时出现的微命令。

::: tip

硬布线控制器中也有微命令与微操作的概念，并非微程序控制器的专有概念。

:::

---

微程序和程序是两个不同的概念：

- 程序是指令的有序集合，用于完成特定的功能。

- 微程序是微指令的有序集合，用于描述机器指令，一条指令的功能由一段微程序来实现。

微程序实际上是机器指令的实时解释器，是由计算机设计者事先编制好并存放在控制存储器中的，一般不提供给用户。对于程序员来说，系统中微程序的结构和功能是透明的，无须知道。

程序最终由机器指令组成，并且由软件设计人员事先编制好并存放在主存储器或者辅助存储器中。

### 结构

![](330.png)

::: tip

主存储器用于存放程序和数据，在CPU外部，用RAM实现。

控制存储器（CM）用于存放微程序，在CPU内部，用ROM实现。存放微指令的控制存储器的单元地址称为微地址。

:::

### 工作过程

实际上就是在微程序控制器的控制下计算机执行机器指令的过程，这个过程可描述为：

1. 执行取指令公共操作。在机器开始运行时，自动地将取指微程序的入口地址送入 $\mu PC$，并从 CM 中读出相应的微指令并送入 $\mu IR$ 。取指微程序的入口地址一般为 CM 的0号单元，取指微程序执行完成后，从主存中取出的机器指令就已存入指令寄存器中。
2. 由机器指令的操作码字段通过微地址形成部件产生该机器指令所对应的微程序的入口地址，并送入 $\mu PC$。
3. 从 CM 中逐条取出对应的微指令并执行。
4. 执行完对应于一条机器指令的一个微程序后，又回到取指微程序的入口地址，继续第1步，以完成取下一条机器指令的公共操作。

以上是一条机器指令的执行过程，如此周而复始，直到整个程序执行完毕。

### 原理

![](331.png)

![](332.png)

### 微指令设计

#### 微指令的编码方式

##### 直接编码方式

直接编码法无须进行译码，微指令的操作控制字段中每一位都代表一个微命令。

设计微指令时，选用或不选用某个微命令，只要将表示该微命令的对应位设置成1或0即可。每个微命令对应并控制数据通路中的一个微操作。

- 优点是简单、直观，执行速度快，操作并行性好。
- 缺点是微指令字长过长，n个微命令就要求微指令的操作字段有n位，造成控制存储器容量极大。

![](334.png)

##### 字段直接编码方式

将微指令的操作控制字段分成若干小字段，把互斥性微命令放在同一字段中，把相容性微命令放在不同字段中，每个字段独立编码，每种编码代表一个微命令且各字段编码含义单独定义，与其他字段无关。

- 缩短微指令字长。
- 因为要通过译码电路后再发出微命令，因此比直接编码方式慢。

![](335.png)

##### 字段间接编码方式

一个字段的某些微命令需由另一个字段中的某些微命令来解释，由于不是靠字段直接译码发出的微命令，因此称为字段间接编码，也称隐式编码。

这种方式可进一步缩短微指令字长，但因削弱了微指令的并行控制能力，因此通常作为字段直接编码方式的一种辅助手段。

![](336.png)

#### 指令的地址形成方式

![](337.png)

####  微指令格式

![](333.png)

水平型微指令和垂直型微指令的比较如下：

1. 水平型微指令并行操作能力强、效率高、灵活性强：垂直型微指令则较差。
2. 水平型微指令执行一条指令的时间短；垂直型微指令执行的时间长。
3. 用水平型微指令编写的微程序，微指令字较长但微程序短；垂直型微指令正好相反。
4. 水平型微指令难以掌握；而垂直型微指令与机器指令比较相似，相对容易掌握。

### 微程序控制单元设计

![](338.png)

![](342.png)

![](343.png)

![](339.png)

## 硬布线与微程序的比较

![](340.png)

# 异常和中断





# 指令流水线





# 多处理器
