---
title: 文件管理
index: 4
typora-root-url: ./..\..\..\..\IMG\docs\计算机\操作系统
---

# 文件的基本概念

文件（File）是以硬盘为载体的存储在计算机上的信息集合，文件可以是文本文档、图片、 程序等。

在系统运行时，计算机以进程为基本单位进行资源的调度和分配；而在用户进行的输入、 输出中，则以文件为基本单位。

大多数应用程序的输入都是通过文件来实现的，其输出也都保存在文件中，以便信息的长期存储及将来的访问。

当用户将文件用于程序的输入、输出时，还希望可以访问、修改和保存文件等，实现对文件的维护管理，这就需要系统提供一个文件管理系统， 操作系统中的文件系统就是用于实现用户的这些管理要求的。 

## 数据项，记录，文件

- 数据项：文件系统中最低级的数据组织形式，可分为： 
  - 基本数据项。用于描述一个对象的某种属性的一个值，是数据中的最小逻辑单位。 
  - 组合数据项。由多个基本数据项组成。 
- 记录：一组相关的数据项的集合，用于描述一个对象在某方面的属性。 
- 文件：由创建者所定义的、具有文件名的一组相关元素的集合，可分为：
  - 有结构文件：文件由若干个相似的记录组成，如一个班的学生记录；
  - 无结构文件：被视为一个字符流，比如一个二进制文件或字符文件。 

## 文件的属性

除了文件数据，操作系统还会保存与文件相关的信息，如所有者、创建时间等，这些附加信 息称为文件属性或文件元数据。

文件属性在不同系统中差别很大，但通常都包括如下属性：名称，类型，创建者，所有者，位置，大小，保护，创建时间、最后一次修改时间和最后一次存取时间。

## 文件的基本操作

![](338.png)

文件属于抽象数据类型。为了正确地定义文件，需要考虑可以对文件执行的操作。操作系统提供系统调用，它对文件进行创建、写、读、重定位、删除和截断等操作。

1. 创建文件

   ![](331.png)

2. 删除文件

   ![](332.png)

3. 打开文件

   ![](333.png)

   ![](334.png)

4. 关闭文件

   ![](335.png)

5. 读文件

   ![](336.png)

6. 写文件

   ![](337.png)

## 文件保护

![](346.png)

### 口令保护

![](342.png)

### 加密保护

![](343.png)

### 访问控制

![](344.png)

![](345.png)

# 文件的逻辑结构

![](293.png)

文件的逻辑结构是从用户观点出发看到的文件的组织形式。文件的物理结构是从实现观点出发看到的文件在外存上的存储组织形式。

文件的逻辑结构与存储介质特性无关，它实际上是指在文件的内部，数据逻辑上是如何组织起来的。 

按逻辑结构，文件可划分为无结构文件和有结构文件两大类。

## 无结构文件

无结构文件是最简单的文件组织形式。无结构文件将数据按顺序组织成记录并积累、保存，它是有序相关信息项的集合，以字节（Byte）为单位。

![](286.png)

## 有结构文件

![](294.png)

由一组相似的记录组成，又称“**记录式文件**”。每条记录又若干个数据项组成。如：数据库表文件。一般来说，每条记录有一个数据项可作为关键字。根据各条记录的长度（占用的存储空间）是否相等，又可分为**定长记录**和**可变长记录**两种。

有结构文件按记录的组织形式可以分为如下几种： 顺序文件，索引文件，索引顺序文件

### 顺序文件

文件中的记录一个接一个地顺序排列（逻辑上），记录可以是**定长**的或**可变长**的。各个记录在物理上可以**顺序存储**或链式存储。

![](287.png)

![](288.png)

### 索引文件

![](289.png)

### 索引顺序文件

索引文件的缺点：每个记录对应一个索引表项，因此索引表可能会很大。比如：文件的每个记录平均只占8B，而每个索引表项占32个字节，那么索引表都要比文件内容本身大4倍，这样对存储空间的利用率就太低了。

![](290.png)

![](291.png)

![](292.png)



# 文件的物理结构

![](320.png)

## 文件块、磁盘块

![](305.png)

![](306.png)

## 连续分配

**连续分配**方式要求每个 文件**在磁盘上占有一组连续的块**。

优点：支持顺序访问和直接访问（即随机访问）；连续分配的文件在顺序访问时速度最快。

缺点：不方便文件拓展；存储空间利用率低，会产生磁盘碎片。

![](307.png)

![](308.png)

![](309.png)

![](310.png)

## 链接分配

链接分配采取离散分配的方式，可以为文件分配离散的磁盘块。分为隐式链接和显式链接两种。

### 隐式链接

除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针。文件目录包括文件第一块的指针和最后一块的指针。

优点：很方便文件拓展，不会有碎片问题，外存利用率高。

缺点：只支持顺序访问，不支持随机访问，查找效率低，指向下一个盘块的指针也需要耗费少量的存储空间。

![](311.png)

![](312.png)

### 显式链接

把用于链接文件各物理块的指针显式地存放在一张表中。即文件分配表（FAT，File Allocation Table）。一个磁盘只会建立一张文件分配表。开机时文件分配表放入内存，并**常驻内存**。

![](313.png)

![](314.png)

## 索引分配

索引分配允许文件离散地分配在各个磁盘块中，系统会**为每个文件建立一张索引表**，索引表中记录了文件的各个逻辑块对应的物理块（索引表的功能类似于内存管理中的页表一一建立逻辑页面到物理页之间的映射关系）。

索引表存放的磁盘块称为**索引块**。文件数据存放的磁盘块称为**数据块**。

![](315.png)

![](316.png)

若文件太大，索索引表项太多，可以采取以下三种方法解决。

### 链接方案

如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放。

![](317.png)

### 多层索引

建立多层索引（原理类似于多级页表）。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。

![](318.png)

采用K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K+1次读磁盘操作。

### 混合索引

多种索引分配方式的结合。例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表）、还包含两级间接索引（指向两层索引表）。

![](319.png)



# 文件目录

![](304.png)

## 文件控制块

![](295.png)

文件控制块（FCB）是用来**存放控制文件需要的各种信息的数据结构**，以实现“按名存取”。 

**FCB的有序集合**称为**文件目录**，一个FCB就是一个文件目录项。

![](296.png)

## 索引结点

> 索引结点也叫i结点(inode)

![](301.png)

![](302.png)

## 目录的操作

![](303.png)

## 目录结构

### 单级目录结构

早期操作系统并不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项。

![](297.png)

### 两级目录结构

早期的多用户操作系统，采用两级目录结构。分为**主文件目录**（MFD，MasterFileDirectory）和**用户文件目录**（UFD，UserFlieDirectory）。

![](298.png)

### 树形目录结构

将两级目录结构加以推广，就形成了树形目录结构。

![](299.png)

###  无环图目录结构

![](300.png)

# 文件存储空间管理 

![](330.png)

## 存储空间的划分与初始化

![](321.png)

## 空闲表法

![](322.png)

## 空闲链表法

![](323.png)

![](324.png)

![](325.png)

## 位示图法

![](326.png)

## 成组链接法

空闲表法、空闲链表法不适用于大型文件系统，因为空闲表或空闲链表可能过大。UNIX系统中采用了成组链接法对磁盘空闲块进行管理。

**文件卷的目录区**中专门用一个磁盘块作为“**超级块**”，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的“超级块”数据一致

![](327.png)

![](328.png)

![](329.png)


# 文件共享

![](341.png)

## 基于索引结点的共享方式(硬链接)

![](339.png)

## 基于符号链的共享方式(软链接) 

![](340.png)


# 文件系统

## 文件系统的层次结构

![](347.png)

![](348.png)

## 文件系统布局

![](349.png)

![](350.png)

![](351.png)

![](352.png)

![](353.png)

## 虚拟文件系统

![](354.png)

![](355.png)

![](356.png)

![](357.png)

虚拟文件系统的特点：

1. 向上层用户进程提供统一标准的系统调用接口，屏蔽底层具体文件系统的实现差异。

2. VFS要求下层的文件系统必须实现某些规定的函数功能，如：open/read/write。一个新的文件系统想要在某操作系统上被使用，就必须满足该操作系统VFS的要求。

3. 每打开一个文件，VFS就在主存中新建一个vnode，用统一的数据结构表示文件，无论该文件存储在哪个文件系统。

   vnode只存在于主存中，而inode既会被调入主存，也会在外存中存储

## 文件系统挂载

![](358.png)

